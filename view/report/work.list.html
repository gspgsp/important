{layout file="public:mini_layout"}
<div class="mini-splitter" style="width:100%;height:100%;">
	<div size="840" showCollapseButton="true">
		<div class="mini-toolbar" style="padding:2px;border-top:0;border-left:0;border-right:0;">
			<style>table p{padding:0; margin:0; padding-top:3px;}</style>
	<table style="width:100%;">
		<tr>
			<td style="white-space:nowrap;">
			<form id="soform">
				添加时间
				<input name="startTime" class="mini-datepicker" style="width:100px;"/> -
				<input name="endTime" class="mini-datepicker" style="width:100px;"/>
				<select name="type" id="soType">
					<option value="" selected="selected">=客户类型=</option>
					{html_options options=$type}
				</select>
				<select name="company_chanel">
					<option value="" selected="selected">=区域=</option>
					{html_options options=$company_chanel}
				</select>
				<select name="status">
					<option value="" selected="selected">=客户状态=</option>
					{html_options options=$company_chanel}
				</select>
				<select name="key_type">
					<option value="c_name" selected="selected">客户名称</option>
					<option value="need_product" >所需牌号</option>
				</select>
				<input name="keyword" class="mini-textbox" emptyText="请输入关键词" style="width:140px;" onenter="onKeyEnter"/>
				<a class="mini-button" iconCls="icon-search" onclick="search()">查询</a>
							<span id="searchMsg"></span>
			   </form>
			</td>
		</tr>
	</table>
		</div>
		<div class="mini-fit">
			<div id="gridCell" class="mini-datagrid" style="width:100%;height:100%;" sizeList="[10,20,50,100]" pageSize="20" allowCellWrap="true"
				borderStyle="border:0;"  url="/user/customer/init?action=grid" showFilterRow="true" allowCellSelect="true" allowCellEdit="true" idField="id"  multiSelect="true"
			>
			<div property="columns">
				<div type="checkcolumn"></div>
				<div field="c_name" width="70" headerAlign="center" allowSort="true" align="center" renderer="onLoadHandle">客户名字</div>
				<div field="action" width="45" headerAlign="center"  align="center" renderer="onLoadFllow">操作</div>
				<div field="type" width="35" headerAlign="center" align="center">客户类型</div>
				<div field="need_product" width="50" headerAlign="center" allowSort="true" align="center" align="center">所需牌号
					<input property="editor" class="mini-textarea" style="width:100%;" minHeight="60"/>
				</div>
				<div field="main_product" width="50" headerAlign="center" allowSort="true" align="center" align="center">主营产品
					<input property="editor" class="mini-textarea" style="width:100%;" minHeight="60"/>
				</div>
				<div field="month_consum" width="50" headerAlign="center" allowSort="true" align="center" align="center">月用量
					<input property="editor" class="mini-textarea" style="width:100%;" minHeight="60"/>
				</div>
				<div field="name" width="30" headerAlign="center" align="center" >客户联系</div>
				<div field="mobile" width="60" headerAlign="center"  align="center">强开</div>
				<div field="remark" width="60" headerAlign="center"  align="center">匹配</div>
			</div>
			</div>
		</div>
	</div>
	<div showCollapseButton="true">
		<div class="mini-toolbar" style="padding:2px;border-top:0;border-left:0;border-right:0;">
			<div style="padding:5px;">
	<div id="infoForm" class="form">
		<div class="mini-tabs" activeIndex="0" plain="false">
			<div title="基本信息">
				<input class="mini-hidden" name="ctype" value="{$ctype}"/>
				<input class="mini-hidden" name="c_id" value="{$user.c_id}"/>
				<input class="mini-hidden" name="info_user_id" value="{$info_ext.user_id}"/>
				<table width="100%">
					<caption><strong>基本信息</strong></caption>
					<tr>
						<td>客户名称：</td>
						<td>
							<input name="c_name" class="mini-textbox" style="width:250px;" maxlength="50" required="true" value="{$user.c_name}"/>
						</td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td>法人姓名：</td>
						<td><input name="legal_person" class="mini-textbox" style="width:70px;" maxlength="6"  value="{$user.legal_person}"/></td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td>法人身份证：</td>
						<td><input name="legal_idcard" class="mini-textbox" style="width:250px;"  value="{$user.legal_idcard}"/></td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td>身份证照片：</td>
						<td colspan="3">
							<input id="img_url5"  name="legal_idcard_pic" class="mini-textbox" value="{$user.legal_idcard_pic}" style="width:200px"/>
							<input id="upfileId5" type="file" name="upFile" onChange="fileUpload(5);">
						</td>
					</tr>
					<tr>
						<td>所需牌号：</td>
						<td><input name="need_product" class="mini-textbox" style="width:250px;" value="{$user.need_product}"/></td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td>主营产品：</td>
						<td><input name="main_product" class="mini-textbox" style="width:250px;"  value="{$user.main_product}"/></td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td style="color:red">注意：</td>
						<td style="color:red">塑料制品企业(原工厂)需要填所需牌号、主营产品，原材料供应商(原贸易商、工贸一体)需要填所需牌号，</td>
					</tr>
					<tr>
						<td style="color:red"></td>
						<td style="color:red">物流服务商需要填主营产品；所需牌号尽量以填写真实牌号，尽量避免使用汉字，以英文逗号分隔。</td>
					</tr>
					<tr>
						<td>月用量：</td>
						<td><input name="month_consum" class="mini-textbox" style="width:250px;"  value="{$user.month_consum}"/></td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td>所在省市</td>
						<td><input name="company_province" id="place_1_0" style="width:80px;" class="mini-combobox" textField="name" valueField="id" onvaluechanged="setReg('place')" data='{:setMiniConfig|$regionList}' value="{$user.company_province}" showNullItem="true"/>
							<input name="company_city" id="place_2_0" url="{if $user.company_province neq ''}/user/user/getRegion?pid={$user.company_province}{/if}" value="{$user.company_city}" class="mini-combobox" style="width:80px;" textField="name" valueField="id" /></td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
			 <!--    <tr>
						<td>邮政编码：</td>
						<td>
							<input name="zip" class="mini-textbox" value="{$user.zip}" style="width:100px;" maxlength="6"  vtype="zip"/>
						</td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr> -->
					<tr>
						<td>成立日期：</td>
						<td><input  class="mini-datepicker"  name="fund_date" value="{$user.fund_date}"/>
						</td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td>注册资本：</td>
						<td>
							<input name="registered_capital" class="mini-textbox" style="width:100px;" required="true" onvalidation="onValidFullMoney" value="{$user.registered_capital|default:}"/>
						万元
						</td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td>实到资本：</td>
						<td>
							<input name="true_capital" class="mini-textbox" style="width:100px;" required="true" onvalidation="onValidFullMoney" value="{$user.true_capital|default:}"/>
							万元
						</td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td>预信用额度：</td>
						<td>
							<input name="pre_credit_limit" class="mini-textbox" style="width:100px;" required="true" onvalidation="onValidFullMoney" value="{$user.pre_credit_limit|default:}"/>
							万元
						</td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					{if $see1}
					<tr>
						<td>信用额度：</td>
						<td>
							<input name="credit_limit" class="mini-textbox" style="width:100px;" required="true" onvalidation="onValidFullMoney" value="{$user.credit_limit|default:}"/>
							万元
						</td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					{/if}
					<tr>
						<td>公司地址：</td>
						<td><input name="address" class="mini-textbox" style="width:250px;" value="{$user.address}"/></td>
						<td></td>
						<td></td>
					</tr>
				</table>
				<table>
					<caption><strong>扩展信息</strong></caption>
					{if $see}
					<tr>
						<td>客户类型：<font style="color:red;">*</font></td>
						<td><input name="type" class="mini-combobox" style="width:150px;" required="true" value="{$user.type}" data='{:setMiniConfig|$type}'  textfield="name" valuefield="id"/></td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					{else}
						<td><input name="type" class="mini-hidden" style="width:150px;" value="{$user.type}" data='{:setMiniConfig|$type}'  textfield="name" valuefield="id"/>
					{/if}
					<tr>
						<td>客户渠道：<font style="color:red;">*</font></td>
						<td><input name="chanel" class="mini-combobox" style="width:150px;" value="{$user.chanel}" data='{:setMiniConfig|$chanel}' required="true" textfield="name" valuefield="id"/></td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td>是否三证合一：<font style="color:red;">*</font></td>
						<td><input id="cards" name="cards" onvaluechanged="changeEvent()" class="mini-combobox" style="width:150px;" value="1" data='{:setMiniConfig|array(0=>'否',1=>'是')}' required="true" textfield="name" valuefield="id"/></td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					<tr class="three hidden">
						<td>营业执照号：</td>
						<td><input class="mini-textbox" style="width:250px;" name="business_licence" value="{$user.business_licence}"/>
						</td>
						<td>执照照片：</td>
						<td>
							<input id="img_url1"  name="business_licence_pic" class="mini-textbox" value="{$user.business_licence_pic}" style="width:70px"/>
							<input id="upfileId1" type="file" name="upFile" onChange="fileUpload(1);">
						</td>
					</tr>
					<tr class="three hidden">
						<td>组织代码：</td>
						<td><input class="mini-textbox" style="width:250px;" name="organization_code" value="{$user.organization_code}"/>
						</td>
						<td>组织图片：</td>
						<td>
							<input id="img_url2"  name="organization_pic" class="mini-textbox" value="{$user.organization_pic}" style="width:70px"/>
							<input id="upfileId2" type="file" name="upFile" onChange="fileUpload(2);">
						</td>
					</tr>
					<tr class="three hidden">
						<td>税务登记码：</td>
						<td><input class="mini-textbox" style="width:250px;" name="tax_registration" value="{$user.tax_registration}"/>
						</td>
						<td>税务图片：</td>
						<td>
							<input id="img_url3"  name="tax_registration_pic" class="mini-textbox" value="{$user.tax_registration_pic}" style="width:70px"/>
							<input id="upfileId3" type="file" name="upFile" onChange="fileUpload(3);">
						</td>
					</tr>

					<tr>
						<td>信用等级：</td>
						<td><input class="mini-combobox" name="credit_level" data='{:setMiniConfig|$credit_level}' textfield="name" valuefield="id" value="{$user.credit_level}"/>
						</td>
						<td>附件地址：</td>
						<td>
							<input id="img_url0"  name="file_url" class="mini-textbox" value="{$user.file_url}" style="width:70px"/>
							<input id="upfileId0" type="file" name="upFile" onChange="fileUpload(0);">
						</td>
					</tr>
					<tr>
						<td>是否授信：</td>
						<td><input class="mini-combobox" name="is_credit" style="width:100px;" data='{:setMiniConfig|$credit}' required="true" textfield="name" valuefield="id" value="{$user.is_credit|default:0}"/></td>
					</tr>
					<tr>
						<td>状态：</td>
						<td><input class="mini-combobox" name="status" style="width:100px;" data='{:setMiniConfig|$status}' textfield="name" valuefield="id" value="{$user.status|default:1}"/></td>
					</tr>
					<tr>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
				</table>
			</div>
			<div title="联系人基本信息">
				<div style="height:385px">
					<table border="0" cellpadding="1" cellspacing="2">
								<tr>
									<td >姓名：</td>
									<td><input name="info_name" class="mini-textbox" style="width:150px;" required="true" vtype="rangeLength:2,30" value="{$info_ext.name}" /></td>
									<td>性别：</td>
									<td><input class="mini-combobox" name="info_sex" style="width:100px;" data='{:setMiniConfig|$sex}' required="true" textField="name" valueField="id" value="{$info_ext.sex}"/></td>
								</tr>
								<tr>
									<td style="width:80px;">手机：</td>
									<td style="width:210px;"><input name="info_mobile" class="mini-textbox" maxlength="11" value="{$info_ext.mobile}" style="width:150px;" required="true" onvalidation="onValidMobile"/></td>
									<td>电话：</td>
									<td><input name="info_tel" class="mini-textbox" style="width:150px;"  value="{$info_ext.tel}" vtype="rangeLength:6,14"/></td>
								</tr>
								<tr>
									<td style="width:80px;">QQ号：</td>
									<td style="width:210px;"><input name="info_qq" class="mini-textbox" maxlength="12" value="{$info_ext.qq}" style="width:150px;"/></td>
									<td>传真：</td>
									<td><input name="info_fax" class="mini-textbox" style="width:150px;" value="{$info_ext.fax}"  vtype="rangeLength:6,14"/></td>
								</tr>
								<tr>
									<td>邮件：</td>
									<td><input name="info_email" class="mini-textbox" style="width:150px;"  value="{$info_ext.email}" vtype="email"/></td>
									<td></td>
									<td></td>
								</tr>
								<tr>
									<td>备注：</td>
									<td colspan="3">
										<input name="info_remark" class="mini-textarea" value="{$info_ext.remark}" style="width:403px; height:50px;"/>
									</td>
								</tr>
								<tr>
									<td>状态：</td>
									<td><input class="mini-combobox" name="info_status" style="width:100px;" data='{:setMiniConfig|$status}' required="true" textField="name" valueField="id" value="{$info_ext.status}"/></td>
								</tr>
								<tr style="height:20px;"></tr>
								<tr>
									<td id="e_m" style="color:red;"></td>
								</tr>
								<tr>
									<td id="e_a"></td>
									<td id="e_name"></td>
									<td id="e_e"></td>
									<td id="ec_name"></td>
								</tr>
								<tr>
									<td id="e_b"></td>
									<td id="e_tel"></td>
									<td id="e_c"></td>
									<td id="e_mobile"></td>
									<td id="e_d"></td>
									<td id="e_customer_manager_name"></td>
								</tr>
							</table>
				</div>
			</div>
		</div><input name="utype" class="mini-textbox" style="display:none" value="3" vtype="utype"/>
		<div align="center" style="margin-top:10px;">
			<a class="mini-button" iconcls="icon-ok" onclick="submitForm">确定</a>
			<a class="mini-button" iconcls="icon-cancel" onclick="onCancel">关闭</a><span id="returnMsg" style="padding-left:5px; color:#F00;"></span>
		</div>
	</div>
</div>
		</div>
	</div>
</div>
<script type="text/javascript">
mini.parse();
var grid = mini.get("gridCell");
grid.load();
var tree = mini.get("nodeTree");
var pGrid = mini.get("pCellList");
var cGrid = mini.get("cCellList");
var isChild=0; //是否操作的是子Grid
//左侧树状
tree.on("nodeselect", function (e) {
	pGrid.show();
	pGrid.load({pid:e.node.id});
	cGrid.hide();
	cGrid.setData([]); //清空数据
	isChild=0;
});

var Status = [{id:0, text: '禁用' }, { id: 1, text: '正常'}];
//格式化状态
function onStatusRenderer(e) {
	for (var i = 0, l = Status.length; i < l; i++) {
		var g = Status[i];
		if (g.id == e.value) return g.text;
	}
	return "";
}
//显示下一级
function switchChild() {
	var record = pGrid.getSelected();
	if(record.id<1) return false; //新增的排除
	if (isChild==0 && record) {
		isChild=1; //操作的是子类
		cGrid.load({pid: record.id});
		cGrid.show();
		pGrid.hide();
		$("#iconSwitch span").text('【返回】父级');
	}else{
		pGrid.show();
		cGrid.hide();
		cGrid.setData([]);
		isChild=0;
		$("#iconSwitch span").text('【查看】子级');
	}
	return;
}
//增加一行
function addRow() {
	var newRow = {name:"",title:"",remark:"",sort_order:0,status:1},obj=null,node=null;
	if(isChild>0){
		node = pGrid.getSelected();
		obj=cGrid;
	}else{
		node = tree.getSelectedNode();
		obj=pGrid;
	}
	if(node) {
		newRow.id = 0;
		newRow.pid = node.id;
		newRow.level = parseInt(node.level)+1;
		newRow.ntype = node.ntype;
		obj.addRow(newRow,0);
	}
}

//增加一行
function addChk() {
	var rows = pGrid.getSelecteds();
	if(rows.length>1){
		alert('审核流程每次只能选择一个节点进行设置');
		return false;
	}else{
		mini.open({
			url: '/rbac/node/admChk?id='+rows[0].id,
			showMaxButton:true,
			title: "设置节点审核流程", width: 215, height:210
		});
	}

}


//保存数据
function saveData() {
	var data=null,obj=null;
	if(isChild){
		obj=cGrid;
	}else{
		obj=pGrid;
	}
	data = obj.getChanges();
	if(data.length<1){
		return;
	}
	var json = mini.encode(data);
	obj.loading("保存中，请稍后......");
	var callback=function(data){
		obj.unmask();
		if(data.err!='0'){
			alert(data.msg);
			return false;
		}else{
			obj.reload();
		}
	}
	utils.ajax('/rbac/node/save',{data:json},callback,"POST","json");
}

//删除数据
function removeRow() {
	var obj=null;
	if(isChild){
		obj=cGrid;
	}else{
		obj=pGrid;
	}
	var rows = obj.getSelecteds(),_ids=new Array();
	if(rows.length<1) return;
	for(var i=0;i<rows.length;i++){
		var _id=parseInt(rows[i].id);
		if(_id<1){
			obj.removeRow(rows[i],false);
		}else{
			_ids[i]=_id;
		}
	}
	var ids=_ids.join(',');
	if(ids=='') return;
	mini.confirm("确定删除节点？", "提示",	function(action){
			if(action!='ok') return;
			var callback=function(data){
				if(data.err!='0'){
					alert(data.msg)
					return false;
				}else{
					obj.reload();
				}
			}
			utils.ajax('/rbac/node/remove',{ids:ids},callback,"POST","json");
		}
	);
}
function onKeyEnterGridSearch(e) {
	gridFilter();
}
function gridFilter(){
	var key = mini.getbyName("keyword").getValue();
	var obj=null,node=null;
	if(isChild){
		obj=cGrid;
		node = pGrid.getSelected();
	}else{
		obj=pGrid;
		node = tree.getSelectedNode();
	}
	obj.load({pid: node.id, key: key });
}

//
function onKeyEnterFilter(e) {
	treeFilter();
}
function treeFilter(){
	var key = mini.getbyName("treekey").getValue();
	if(key == "") {
		tree.clearFilter();
	} else {
		key = key.toLowerCase();
		tree.filter(function (node) {
			var name = node.name ? node.name.toLowerCase() : "";
			var title = node.title ? node.title.toLowerCase() : "";
			if (name.indexOf(key) != -1 || title.indexOf(key) != -1) {
				return true;
			}
		});
	}
}
function updateAccess(){
	isChild=0; //强制为父类
	pGrid.show();
	cGrid.hide();
	pGrid.loading("保存中，请稍后......");
	var callback=function(data){
		pGrid.unmask();
		if(data.err!='0'){
			alert(data.msg);
			return false;
		}else{
			pGrid.reload();
		}
	}
	utils.ajax('/rbac/node/updateMenuAccess',{data:''},callback,"POST","json");
}
</script>