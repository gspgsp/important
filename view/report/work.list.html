{layout file="public:mini_layout"}
<div class="mini-splitter" style="width:100%;height:100%;">
	<div size="840" showCollapseButton="true">
		<div class="mini-toolbar" style="padding:2px;border-top:0;border-left:0;border-right:0;">
			<style>table p{padding:0; margin:0; padding-top:3px;}</style>
	<table style="width:100%;">
		<tr>
			<td style="white-space:nowrap;">
			<form id="csoform">
				添加时间
				<input name="startTime" class="mini-datepicker" style="width:100px;"/> -
				<input name="endTime" class="mini-datepicker" style="width:100px;"/>
				<select name="type" id="soType">
					<option value="" selected="selected">=客户类型=</option>
					{html_options options=$type}
				</select>
				<select name="company_chanel">
					<option value="" selected="selected">=区域=</option>
					{html_options options=$belong_area}
				</select>
				<select name="status">
					<option value="" selected="selected">=客户状态=</option>
					{html_options options=$cus_status}
				</select>
				<select name="key_type">
					<option value="c_name" selected="selected">客户名称</option>
					<option value="need_product" >所需牌号</option>
					<option value="customer_manager">交易员</option>
				</select>
				<input name="keyword" class="mini-textbox" emptyText="请输入关键词" style="width:140px;" onenter="conKeyEnter"/>
				<a class="mini-button" iconCls="icon-search" onclick="csearch()">查询</a>
				<span id="csearchMsg"></span>
			   </form>
			</td>
		</tr>
	</table>
		</div>
		<div class="mini-fit">
				<div id="gridCells" class="mini-datagrid" style="width:100%;height:100%;" sizeList="[10,20,50,100]" pageSize="20" allowCellWrap="true"
					borderStyle="border:0;"  url="/user/customer/init?action=grid" showFilterRow="true" allowCellSelect="true" allowCellEdit="true"  multiSelect="true"
				>
				<div property="columns">
					<div type="checkcolumn" width="15"></div>
					<div field="c_name" width="70" headerAlign="center" allowSort="true" align="center" renderer="onLoadHandle">客户名字</div>
					<div field="action" width="45" headerAlign="center"  align="center" renderer="onLoadFllow">操作</div>
					<div field="type" width="35" headerAlign="center" align="center">客户类型</div>
					<div field="need_product" width="50" headerAlign="center" allowSort="true" align="center" align="center">所需牌号
						<input property="editor" class="mini-textarea" style="width:100%;" minHeight="60"/>
					</div>
					<div field="main_product" width="50" headerAlign="center" allowSort="true" align="center" align="center">主营产品
						<input property="editor" class="mini-textarea" style="width:100%;" minHeight="60"/>
					</div>
					<div field="month_consum" width="30" headerAlign="center" allowSort="true" align="center" align="center">月用量
						<input property="editor" class="mini-textarea" style="width:100%;" minHeight="60"/>
					</div>
					<div field="name" width="30" headerAlign="center" align="center" >客户联系</div>
					<div field="mobile" width="60" headerAlign="center"  align="center">强开</div>
					<div field="remark" width="60" headerAlign="center"  align="center">匹配</div>
				</div>
			</div>
		</div>
	</div>
	<div showCollapseButton="true">
		<div class="mini-tabs" activeIndex="0" plain="false" onactivechanged="changeTab">

			<div title="&nbsp;&nbsp;&nbsp;&nbsp;库 存 信 息&nbsp;&nbsp;&nbsp;&nbsp;">
				<div class="mini-toolbar" style="padding:2px;border-top:0;border-left:0;border-right:0;">
					<style>table p{padding:0; margin:0; padding-top:3px;}</style>
					<table style="width:100%;">
						<tr>
							<td style="white-space:nowrap;">
							<form id="soform">
								添加时间
								<input name="startTime" class="mini-datepicker" style="width:100px;"/> -
								<input name="endTime" class="mini-datepicker" style="width:100px;"/>
								<select name="key_type">
									<option value="c_name" selected="selected">客户名称</option>
									<option value="need_product" >所需牌号</option>
								</select>
								<input name="keyword" class="mini-textbox" emptyText="请输入关键词" style="width:140px;" onenter="onKeyEnter"/>
								<a class="mini-button" iconCls="icon-search" onclick="search()">查询</a>
											<span id="searchMsg"></span>
							</form>
							</td>
						</tr>
					</table>
				</div>
				<div id="investGrid" class="mini-datagrid" style="width:auto;height:540px;" idField="id"  url="/user/contact/init?action=grid&c_id={$c_id}&filte=1" sizeList="[10,20,50,100]" pageSize="20">
					<div property="columns">
						<div field="user_id" width="50" headerAlign="center" renderer="onLoadHandle" align="center">牌号/厂家</div>
						<div field="name" width="50" headerAlign="center" align="center">价格/仓库</div>
						<div field="is_default" width="50" headerAlign="center" align="center" renderer="defu">区域/吨数</div>
						<div field="c_id" width="80" headerAlign="center" align="center">采购人</div>
						<div field="sex" width="60" headerAlign="center"  align="center">时间</div>
						<div action="" width="80" headerAlign="center" align="center">操作</div>
						<div field="remark" width="80" headerAlign="center" align="center">备注</div>
					</div>
				</div>
			</div>
			<div title="&nbsp;&nbsp;&nbsp;&nbsp;采 购 信 息&nbsp;&nbsp;&nbsp;&nbsp;">
				<div class="mini-toolbar" style="padding:2px;border-top:0;border-left:0;border-right:0;">
						<style>table p{padding:0; margin:0; padding-top:3px;}</style>
						<table style="width:100%;">
							<tr>
								<td style="white-space:nowrap;">
								<form id="soform">
									添加时间
									<input name="startTime" class="mini-datepicker" style="width:100px;"/> -
									<input name="endTime" class="mini-datepicker" style="width:100px;"/>
									<select name="key_type">
										<option value="c_name" selected="selected">客户名称</option>
										<option value="need_product" >所需牌号</option>
									</select>
									<input name="keyword" class="mini-textbox" emptyText="请输入关键词" style="width:140px;" onenter="onKeyEnter"/>
									<a class="mini-button" iconCls="icon-search" onclick="search()">查询</a>
												<span id="searchMsg"></span>
								</form>
								</td>
							</tr>
						</table>
					</div>
				<div id="gridCell" class="mini-datagrid" style="width:auto;height:540px;" url="/user/follow/init?action=grid&c_id={$c_id}"  idField="id"
					 sizeList="[10,20,50,100]" pageSize="20">
					<div property="columns">
						<div field="user_id" width="50" headerAlign="center" renderer="onLoadHandle" align="center">牌号/厂家</div>
						<div field="name" width="50" headerAlign="center" align="center">价格/仓库</div>
						<div field="is_default" width="50" headerAlign="center" align="center" renderer="defu">区域/吨数</div>
						<div field="c_id" width="80" headerAlign="center" align="center">采购人</div>
						<div field="sex" width="60" headerAlign="center"  align="center">时间</div>
						<div action="" width="80" headerAlign="center" align="center">操作</div>
						<div field="remark" width="80" headerAlign="center" align="center">备注</div>
					</div>
				</div>
			</div>

		</div>
	</div>
</div>
<script type="text/javascript">
mini.parse();
//加载客户
var grids = mini.get("gridCell");
grids.load();

//加载左侧信息
var grid = mini.get("gridCells");
grid.load();
//对客户进行搜索
function csearch() {
	grid.load($("#csoform").serializeObject(),function(e){
		$("#csearchMsg").html(e.msg);
	});
}
function conKeyEnter(e) {
	csearch();
}
//客户的操作相关按钮
function onLoadFllow(e) {
	var record = e.record,cid=record.c_id, status=record.status,s='',customer_manager=record.customer_manager,bli=record.bli,issale=record.is_sale;
	s += '<a href="javascript:new_useless('+cid+')">公开</a><a href="javascript:viewFinfo('+cid+')">跟</a><a href="javascript:contract('+cid+')">联系人</a>'
	return s;
}
//新版的作废客户
function new_useless(cid){
	mini.open({
	url: "/product/interface/useless?id="+cid,
	title: '把客户作废', width: 500, height:300,
	ondestroy: function (action) {
	  if(action=='save'){ //重新加载
		grid.reload();
	  }
	}
	});
}
//获取联系人
function contract(cid){
	mini.open({
		url: "/user/contact/init?c_id="+cid,
		showMaxButton:true,
		title: "客户联系人",
		width: 990, height:460,
		ondestroy: function (action) {
			if(action=='save'){ //重新加载
				grid.reload();
			}
		}
	});
}
//打开跟进客户信息页面
function viewFinfo(c_id){
	mini.open({
		url: "/user/follow/info?id="+c_id,
		showMaxButton:true,
		title: "新增客户跟进",
		width: 300, height:320
	});
}
//编辑联系人
function onLoadHandle(e) {
	var record = e.record,uid=record.c_id, c_name=record.c_name, s='';
	s += '<a href="javascript:viewCinfo('+uid+')">'+c_name+'</a> ';
	return s;
}










var Status = [{id:0, text: '禁用' }, { id: 1, text: '正常'}];
//格式化状态
function onStatusRenderer(e) {
	for (var i = 0, l = Status.length; i < l; i++) {
		var g = Status[i];
		if (g.id == e.value) return g.text;
	}
	return "";
}
//增加一行
function addRow() {
	var newRow = {name:"",title:"",remark:"",sort_order:0,status:1},obj=null,node=null;
	if(isChild>0){
		node = pGrid.getSelected();
		obj=cGrid;
	}else{
		node = tree.getSelectedNode();
		obj=pGrid;
	}
	if(node) {
		newRow.id = 0;
		newRow.pid = node.id;
		newRow.level = parseInt(node.level)+1;
		newRow.ntype = node.ntype;
		obj.addRow(newRow,0);
	}
}


//保存数据
function saveData() {
	var data=null,obj=null;
	if(isChild){
		obj=cGrid;
	}else{
		obj=pGrid;
	}
	data = obj.getChanges();
	if(data.length<1){
		return;
	}
	var json = mini.encode(data);
	obj.loading("保存中，请稍后......");
	var callback=function(data){
		obj.unmask();
		if(data.err!='0'){
			alert(data.msg);
			return false;
		}else{
			obj.reload();
		}
	}
	utils.ajax('/rbac/node/save',{data:json},callback,"POST","json");
}

//删除数据
function removeRow() {
	var obj=null;
	if(isChild){
		obj=cGrid;
	}else{
		obj=pGrid;
	}
	var rows = obj.getSelecteds(),_ids=new Array();
	if(rows.length<1) return;
	for(var i=0;i<rows.length;i++){
		var _id=parseInt(rows[i].id);
		if(_id<1){
			obj.removeRow(rows[i],false);
		}else{
			_ids[i]=_id;
		}
	}
	var ids=_ids.join(',');
	if(ids=='') return;
	mini.confirm("确定删除节点？", "提示",	function(action){
			if(action!='ok') return;
			var callback=function(data){
				if(data.err!='0'){
					alert(data.msg)
					return false;
				}else{
					obj.reload();
				}
			}
			utils.ajax('/rbac/node/remove',{ids:ids},callback,"POST","json");
		}
	);
}
</script>