{layout file="public:mini_layout"}
<style type="text/css">
	.hidden{
		display: none;
	}
</style>
<div class="mini-splitter" style="width:100%;height:100%;">
	<div size="845" showCollapseButton="true">
		<div class="mini-toolbar" style="padding:2px;border-top:0;border-left:0;border-right:0;">
		<style>table p{padding:0; margin:0; padding-top:3px;}</style>
			<table style="width:100%;">
				<tr>
					<td style="white-space:nowrap;">
					<form id="csoform">
						添加时间
						<input name="startTime" class="mini-datepicker" style="width:100px;"/> -
						<input name="endTime" class="mini-datepicker" style="width:100px;"/>
						<select name="type" id="soType">
							<option value="" selected="selected">=客户类型=</option>
							{html_options options=$type}
						</select>
						<select name="china_area">
							<option value="" selected="selected">=区域=</option>
							{html_options options=$belong_area}
						</select>
						<select name="cus_status">
							<option value="" selected="selected">=客户状态=</option>
							{html_options options=$cus_status}
						</select>
						<select name="key_type">
							<option value="c_name" selected="selected">客户名称</option>
							<option value="need_product" >所需牌号</option>
							<option value="customer_manager">交易员</option>
						</select>
						<input name="keyword" class="mini-textbox" emptyText="请输入关键词" style="width:140px;" onenter="conKeyEnter"/>
						<a class="mini-button" iconCls="icon-search" onclick="csearch()">查询</a>
						<span id="csearchMsg"></span>
					   </form>
					</td>
				</tr>
			</table>
		</div>
		<div class="mini-fit">
				<div id="gridCells" class="mini-datagrid" style="width:100%;height:240px;" sizeList="[10,20,50,100]" pageSize="20" allowCellWrap="true"
					borderStyle="border:0;"  url="/user/customer/init?action=grid" showFilterRow="true" allowCellSelect="true" allowCellEdit="true"  multiSelect="true"
				>
				<div property="columns">
					<div type="checkcolumn" width="15"></div>
					<div field="c_name" width="70" headerAlign="center" allowSort="true" align="center" renderer="onLoadHandle">客户名字</div>
					<div field="action" width="45" headerAlign="center"  align="center" renderer="onLoadFllow">操作</div>
					<div field="type" width="35" headerAlign="center" align="center">客户类型</div>
					<div field="need_product" width="50" headerAlign="center" allowSort="true" align="center" align="center">所需牌号
						<input property="editor" class="mini-textarea" style="width:100%;" minHeight="60"/>
					</div>
					<div field="main_product" width="50" headerAlign="center" allowSort="true" align="center" align="center">主营产品
						<input property="editor" class="mini-textarea" style="width:100%;" minHeight="60"/>
					</div>
					<div field="month_consum" width="30" headerAlign="center" allowSort="true" align="center" align="center">月用量
						<input property="editor" class="mini-textarea" style="width:100%;" minHeight="60"/>
					</div>
					<div field="name" width="30" headerAlign="center" align="center" >客户联系</div>
					<div field="mobile" width="60" headerAlign="center"  align="center">强开</div>
					<div field="remark" width="60" headerAlign="center"  align="center">匹配</div>
				</div>
			</div>
		</div>
	</div>
	<div showCollapseButton="true">
		<div class="mini-tabs" activeIndex="0" plain="false" onactivechanged="changeTab">
			<div title="==库 存 信 息==">
				<div class="mini-toolbar" style="padding:2px;border-top:0;border-left:0;border-right:0;">
					<style>table p{padding:0; margin:0; padding-top:3px;}</style>
					<table style="width:100%;">
						<tr>
							<td style="white-space:nowrap;">
							<form id="soform">
								添加时间
								<input name="startTime" class="mini-datepicker" style="width:100px;"/> -
								<input name="endTime" class="mini-datepicker" style="width:100px;"/>
								<select name="key_type">
									<option value="c_name" selected="selected">客户名称</option>
									<option value="need_product" >所需牌号</option>
								</select>
								<input name="keyword" class="mini-textbox" emptyText="请输入关键词" style="width:140px;" onenter="onKeyEnter"/>
								<a class="mini-button" iconCls="icon-search" onclick="search()">查询</a>
											<span id="searchMsg"></span>
							</form>
							</td>
						</tr>
					</table>
				</div>
				<div id="investGrid" class="mini-datagrid" style="width:auto;height:280px;" url="/product/storeDetail/init?action=grid&isAddSale=1" sizeList="[10,20,50,100]" pageSize="20">
					<div property="columns">
						<div field="model" width="50" headerAlign="center" align="center" allowSort="true" renderer="onLoadProduct">牌号</div>
						<div field="f_name" width="55" headerAlign="center" align="center" allowSort="true">厂家</div>
						<div field="store_name" width="50" headerAlign="center" align="center" allowSort="true">仓库</div>
						<div field="unit_price" width="60"  headerAlign="center" align="center" allowSort="true">采购价</div>
						<div field="controlled_number" width="40" headerAlign="center" align="center" allowSort="true">可用数量</div>
						<div field="customer_manager" width="35" headerAlign="center" align="center">采购人</div>
						<div field="input_time" width="70" headerAlign="center" allowSort="true" dateFormat="yy-MM-dd HH:mm" align="center">时间</div>
						<div action="" width="50" headerAlign="center" align="center" renderer="send">操作</div>
					</div>
				</div>
			</div>

			<div title="==采 购 信 息==">
				<div class="mini-toolbar" style="padding:2px;border-top:0;border-left:0;border-right:0;">
						<style>table p{padding:0; margin:0; padding-top:3px;}</style>
						<table style="width:100%;">
							<tr>
								<td style="white-space:nowrap;">
								<form id="soform">
									添加时间
									<input name="startTime" class="mini-datepicker" style="width:100px;"/> -
									<input name="endTime" class="mini-datepicker" style="width:100px;"/>
									<select name="key_type">
										<option value="c_name" selected="selected">客户名称</option>
										<option value="need_product" >所需牌号</option>
									</select>
									<input name="keyword" class="mini-textbox" emptyText="请输入关键词" style="width:140px;" onenter="onKeyEnter"/>
									<a class="mini-button" iconCls="icon-search" onclick="search()">查询</a>
												<span id="searchMsg"></span>
								</form>
								</td>
							</tr>
						</table>
					</div>
				<div id="gridCell" class="mini-datagrid" style="width:auto;height:480px;" url="/wk/wk/getDatas"
					 sizeList="[10,20,50,100]" pageSize="20">
					<div property="columns">
						<div field="fmodel" width="50" headerAlign="center" align="center">牌号/厂家</div>
						<div field="hinfo" width="50" headerAlign="center" align="center">价格/仓库</div>
						<div field="ainfo" width="50" headerAlign="center" align="center">区域/吨数</div>
						<div field="uname" width="40" headerAlign="center" align="center">采购人</div>
						<div field="input_time" width="60" headerAlign="center"  align="center" dateFormat="yy-MM-dd HH:mm" align="center">时间</div>
						<div action="" width="30" headerAlign="center" align="center" renderer="republish">操作</div>
						<div field="remark" width="30" headerAlign="center" align="center">备注</div>
					</div>
				</div>
			</div>

			<div title="==报 价 信 息==">
				<div class="mini-toolbar" style="padding:2px;border-top:0;border-left:0;border-right:0;">
						<style>table p{padding:0; margin:0; padding-top:3px;}</style>
						<table style="width:100%;">
							<tr>
								<td style="white-space:nowrap;">
								<form id="soform">
									添加时间
									<input name="startTime" class="mini-datepicker" style="width:100px;"/> -
									<input name="endTime" class="mini-datepicker" style="width:100px;"/>
									<select name="key_type">
										<option value="c_name" selected="selected">客户名称</option>
										<option value="need_product" >所需牌号</option>
									</select>
									<input name="keyword" class="mini-textbox" emptyText="请输入关键词" style="width:140px;" onenter="onKeyEnter"/>
									<a class="mini-button" iconCls="icon-search" onclick="search()">查询</a>
												<span id="searchMsg"></span>
								</form>
								</td>
							</tr>
						</table>
					</div>
				<div id="bjCell" class="mini-datagrid" style="width:auto;height:480px;" url="/wk/wk/getDatas?stype=2"
					 sizeList="[10,20,50,100]" pageSize="20">
					<div property="columns">
						<div field="fmodel" width="50" headerAlign="center" align="center">需求信息</div>
						<div field="sale_price" width="50" headerAlign="center" align="center">价格</div>
						<div field="num" width="50" headerAlign="center" align="center">吨数</div>
						<div field="uname" width="40" headerAlign="center" align="center">报价人</div>
						<div field="input_time" width="60" headerAlign="center" align="center" dateFormat="yy-MM-dd HH:mm" align="center">时间</div>
						<div action="" width="30" headerAlign="center" align="center" renderer="republish">操作</div>
						<div field="remark" width="30" headerAlign="center" align="center">备注</div>
					</div>
				</div>
			</div>
		</div>
		<fieldset style="width:643px;border:solid 1px #aaa;margin-top:8px;position:relative;">
			<legend><label><input id="rbl" name="stype" value="2" class="mini-radiobuttonlist" data="[{id: 1, text: '采购'}, {id: 2, text: '报价'}]"/></label></legend>
			<div id="editForm1" style="padding:5px;width:640px;overflow: hidden;" >
				<table style="width:570px;float: left;">
					<tr>
						<td style="width:50px;">牌号：<font style="color:red;">*</font></td>
						<td style="width:100px;"><input name="model" class="mini-textbox" required="true"/></td>
						<td style="width:50px;">厂家：<font style="color:red;">*</font></td>
						<td style="width:100px;"><input name="factory" class="mini-textbox" required="true"/></td>
						<td style="width:50px;">数量：<font style="color:red;">*</font></td>
						<td style="width:100px;"><input name="num" class="mini-textbox" required="true"/></td>
					</tr>
					<tr>
						<td>价格：<font style="color:red;">*</font></td>
						<td><input name="sale_price" class="mini-textbox" required="true"/></td>
						<td>备注：</td>
						<td>
							<input name="remark" class="mini-textbox"/>
							<input name="stype" value="2" class="mini-hidden"/>
						</td>
					</tr>
				</table>
				<div style="width: 30px;float: right;" borderStyle="border:0;">
						<a class="mini-button" style="width:30px;" onClick="submitForm1()">发布</a>
				</div>
			</div>
			<div id="editForm2" style="padding:5px;width:640px;overflow: hidden;" class="hidden">
				<table style="width:570px;float: left;">
					<tr>
						<td style="width:80px;">牌号：<font style="color:red;">*</font></td>
						<td style="width:60px;"><input name="model" class="mini-textbox" required="true" emptyText="牌号"/></td>
						<td style="width:80px;">厂家：<font style="color:red;">*</font></td>
						<td style="width:60px;"><input name="factory" class="mini-textbox" required="true" emptyText="厂家"/></td>
						<td style="width:100px;">相似牌号：</td>
						<td style="width:60px;"><input name="smodel" class="mini-textbox" emptyText="相似牌号，该牌号也发信息，多个用空格分隔"/></td>
					</tr>
					<tr>
						<td>数量：<font style="color:red;">*</font></td>
						<td><input name="num" class="mini-textbox" required="true"/></td>
						<td>成本：<font style="color:red;">*</font></td>
						<td><input name="price" class="mini-textbox" required="true"/></td>
						<td>销售价：<font style="color:red;">*</font></td>
						<td><input name="sale_price" class="mini-textbox" required="true"/></td>
					</tr>
					<tr>
						<td>仓库：<font style="color:red;">*</font></td>
						<td><input name="store" class="mini-textbox" required="true"/></td>
						<td>区域：<font style="color:red;">*</font></td>
						<td><input name="china_area" class="mini-combobox" data="[{id: 1, text: '华东'},{id: 2, text: '华北'},{id: 3, text: '华南'},{id: 4, text: '其他'}]" textField="text" valueField="id" required="true"/></td>
						<td>备注：</td>
						<td>
							<input name="remark" class="mini-textbox"/>
							<input name="stype" value="1" class="mini-hidden"/>
						</td>
					</tr>
				</table>
				<div style="width: 30px;float: right;" borderStyle="border:0;">
						<a class="mini-button" style="width:30px;" onClick="submitForm2()">发布</a>
				</div>
			</div>
		</fieldset>
	</div>
</div>
<script type="text/javascript">
mini.parse();
var form1 = new mini.Form("#editForm1");
var form2 = new mini.Form("#editForm2");


var grids = mini.get("gridCell");
grids.load();

//报价
var bjgrids = mini.get("bjCell");
bjgrids.load();

//加载左侧信息
var grid = mini.get("gridCells");
var supplier = parseInt({$supplier});
var cooperation = parseInt({$cooperation});
grid.load();
//对客户进行搜索
function csearch() {
	grid.load($("#csoform").serializeObject(),function(e){
		$("#csearchMsg").html(e.msg);
	});
}
function conKeyEnter(e) {
	csearch();
}
//客户的操作相关按钮
function onLoadFllow(e) {
	var record = e.record,cid=record.c_id, status=record.status,s='',customer_manager=record.customer_manager,bli=record.bli,issale=record.is_sale;
	s += '<a href="javascript:new_useless('+cid+')">公开</a>|<a href="javascript:contract('+cid+')">联系人</a></br><a href="javascript:removeRow('+cid+')">黑</a>|<a href="javascript:yellow('+cid+')">黄</a>|<a href="javascript:viewFinfo('+cid+')">跟</a>'
	return s;
}
function send(e){
	var record = e.record,id=record.id,s='';
	return s += '<a href="javascript:sends('+id+')">发短信</a>';
}
//发送短信回调方法
function sends(e){

}
//采购报价发布确认按钮
function submitForm1(){
	form1.validate();
	if(form1.isValid() == false) return;
	//提交数据
	var o = form1.getData();
	var json = mini.encode(o);
	$("#returnMsg").text('');
	form1.loading("数据提交中，请稍后......");
	var urlstr = '/wk/wk/poublish';
	$.post(urlstr,{data:json},function(data){
		form1.unmask();
		if(data.err=='0'){
			bjgrids.reload();
		}else{
			alert(data.msg);
		}
	},'json');
}
//采购报价发布确认按钮
function submitForm2(){
	form2.validate();
	if(form2.isValid() == false) return;
	//提交数据
	var o = form2.getData();
	var json = mini.encode(o);
	$("#returnMsg").text('');
	form2.loading("数据提交中，请稍后......");
	var urlstr = '/wk/wk/poublish';
	$.post(urlstr,{data:json},function(data){
		form2.unmask();
		$("#returnMsg").text(data.msg);
		if(data.err=='0'){
			grids.reload();
		}else{
			alert(data.msg);
		}
	},'json');
}
//单选切换
var rbl = mini.get("rbl");
rbl.on("valuechanged",function (e) {
	var val = this.getValue();
	if(val == 2){
		$('#editForm1').removeClass('hidden');
		$('#editForm2').addClass('hidden');
	}else{
		$('#editForm2').removeClass('hidden');
		$('#editForm1').addClass('hidden');
	}
});
//报价从新发布
function republish(e){
	var record = e.record,id=record.id,s='';
	return s += '<a href="javascript:publish('+id+')">重新发布</a>';
}
//发送短信回调方法
function publish(e){

}
//新版的作废客户
function new_useless(cid){
	mini.open({
	url: "/product/interface/useless?id="+cid,
	title: '把客户作废', width: 500, height:300,
	ondestroy: function (action) {
	  if(action=='save'){ //重新加载
		grid.reload();
	  }
	}
	});
}
//获取联系人
function contract(cid){
	mini.open({
		url: "/user/contact/init?c_id="+cid,
		showMaxButton:true,
		title: "客户联系人",
		width: 990, height:460,
		ondestroy: function (action) {
			if(action=='save'){ //重新加载
				grid.reload();
			}
		}
	});
}
//打开跟进客户信息页面
function viewFinfo(c_id){
	mini.open({
		url: "/user/follow/info?id="+c_id,
		showMaxButton:true,
		title: "新增客户跟进",
		width: 300, height:320
	});
}
//编辑联系人
function onLoadHandle(e) {
	var record = e.record,uid=record.c_id, c_name=record.c_name, s='';
	s += '<a href="javascript:viewCinfo('+uid+')">'+c_name+'</a> ';
	return s;
}
//标示黄名单
function yellow(cid) {
	mini.confirm("确定标记为黄名单？", "提示",	function(action){
			if(action!='ok') return;
			var callback=function(data){
				if(data.err!='0'){
					alert(data.msg);
					return false;
				}else{
					grid.reload();
				}
			}
			utils.ajax('/user/customer/yellow',{ids:cid},callback,"POST","json");
		}
	);
}
//删除数据
function removeRow(cid) {
	mini.confirm("确定加入黑名单？", "提示",function(action){
			if(action!='ok') return;
			var callback=function(data){
				if(data.err!='0'){
					alert(data.msg);
					return false;
				}else{
					grid.reload();
				}
			}
			if(supplier == 1){
				utils.ajax('/user/customer/remove_supplier',{ids:cid},callback,"POST","json");
			}else if(cooperation == 1){
				utils.ajax('/user/customer/remove_cooperation',{ids:cid},callback,"POST","json");
			}else{
				utils.ajax('/user/customer/remove',{ids:cid},callback,"POST","json");
			}

		}
	);
}
function changeTab(e){
	var investGrid=mini.get("investGrid"), gridCell=mini.get("gridCell"),bjCell=mini.get("bjCell");
	var tab=e.tab;
	if(tab.title=='==库 存 信 息=='){
		var data=investGrid.getData();
		if(data.length<1){
			investGrid.load();
		}
	}
	if(tab.title=='==采 购 信 息=='){
		var data=gridCell.getData();
		if(data.length<1){
			gridCell.load();
		}
	}
	if(tab.title=='==报 价 信 息=='){
		var data=bjCell.getData();
		if(data.length<1){
			bjCell.load();
		}
	}
}
//追加查看产品按钮
function onLoadProduct(e){
	var record = e.record,s='',p_id = record.p_id,model=record.model;
	s += '<a href="javascript:viewProInfo('+p_id+')">'+model+'</a> ';
	return s;
}
//查看产品相关信息
function viewProInfo(pid){
	mini.open({
		url: "/product/product/info?pid="+pid,
		showMaxButton:true,
		title: "产品相关信息",
		width: 250, height:250
	});
}
var Status = [{id:0, text: '禁用' }, { id: 1, text: '正常'}];

</script>