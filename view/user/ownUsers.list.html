{layout file="public:mini_layout"}
<div class="mini-toolbar" style="margin:3px 3px 0;">
    <table style="width:100%;">
        <tr>
            <td style="white-space:nowrap;">
            <form id="soform">
              <select name="status" id="soStatus">
                	<option value="">状态</option>
                    {html_options options=$status}
                </select>
            	<select name="utype" id="soUtype">
                	<option value="">类型</option>
                    {html_options options=$utype}
                </select>
            	<select name="key_type">
                    <option value="mobile">手机号</option>
                    <option value="real_name">姓名</option>
                    <option value="u.user_id">会员ID</option>
                    <option value="email">Email</option>
                    <option value="reg_ip">IP</option>
                </select>       
                <input name="keyword" class="mini-textbox" emptyText="请输入关键词" style="width:140px;" onenter="onKeyEnter"/>   
                <a class="mini-button" iconCls="icon-search" onclick="search()">查询</a>
                <span id="searchMsg"></span></form>
            </td>
            <td style="float:right;">&nbsp;</td>
        </tr>
    </table>           
</div>

<div class="mini-fit" style="padding:1px 3px 3px;">
    <div id="gridCell" class="mini-datagrid" style="width:100%;height:100%;"  sizeList="[10,20,50,100]" pageSize="20"
        url="/user/user/viewOwnUsers?action=grid&id={$user_id}&atpye={$atpye}&do={$doact}" idField="user_id"  onrowdblclick="onRowDblClick"
        {if $doact neq 'search'} allowCellSelect="true" allowCellEdit="true" multiSelect="true"{/if}
        >
        <div property="columns">    
            {if $doact neq 'search'}<div type="checkcolumn"></div>{/if}
      		<div field="user_id" width="50" headerAlign="center" align="center" allowSort="true" {if $doact neq 'search'}renderer="onLoadUinfo"{/if}>ID</div>
            <div field="mobile" width="60" headerAlign="center">手机</div>
            <div field="ref_count" width="40" headerAlign="center" allowSort="true" align="center" renderer="onLoadRec">推荐数</div>
            <div field="email" width="60" headerAlign="center">邮件</div>
            <div field="real_name" width="50" headerAlign="center">姓名</div>
            <div field="status" width="60" headerAlign="center" align="center">状态</div>
            <div field="reg_time" width="90" headerAlign="center" dateFormat="yyyy-MM-dd HH:mm" align="center">注册时间</div>
            <div field="last_login" width="90" headerAlign="center" dateFormat="yyyy-MM-dd HH:mm" align="center">最后登录</div>
            <div field="visit_count" width="50" headerAlign="center" allowSort="true" align="center">登录次数</div>
            <div field="reg_ip" width="80" headerAlign="center" align="center" allowSort="true">IP</div>
        </div>
    </div>
</div>
{if $doact eq 'search'}
<div class="mini-toolbar" style="text-align:center;padding-top:8px;padding-bottom:8px;" borderStyle="border:0;">
        <a class="mini-button" style="width:60px;" onClick="onComfirm()">确定</a>
        <span style="display:inline-block;width:25px;"></span>
        <a class="mini-button" style="width:60px;" onClick="onCancel()">取消</a>
</div>
{/if}

<script type="text/javascript">
mini.parse();
var grid = mini.get("gridCell");
grid.load();

function search() {
	grid.load($("#soform").serializeObject(),function(e){
		$("#searchMsg").html(e.msg);
	});
}
function onKeyEnter(e) {
	search();
}

function onRowDblClick(e) {
	{if $doact neq 'search'}
	edit();
	{else}
	onComfirm();
	{/if}
}
function edit() {
	var row = grid.getSelected();
	if (row) {
		add(row.user_id)
	}
}

//查看编辑用户信息
function add(id,ctype){
	var width=900,height=500,title='用户信息';
	if(id==0){
		width=600;
		height=580;
		title='新增筹资机构'
	}
	mini.open({
		url: "/user/user/info?id="+id+"&ctype="+ctype,
		showMaxButton:true,
		title: title, width: width, height:height,
		ondestroy: function (action) {
			if(action=='save'){ //重新加载
				grid.reload();
			}
		}
	});	
}

//筛选数据
function CloseWindow(action) {
	if (window.CloseOwnerWindow) return window.CloseOwnerWindow(action);
	else window.close();
}
function onComfirm() {
	CloseWindow("ok");
}
function onCancel() {
	CloseWindow("cancel");
}
function GetData() {
	var row = grid.getSelected();
	return row;
}

function onLoadRec(e){
	var record = e.record.ref_count, s='-';
	if(record!=='0'){
		s = '<a href="javascript:viewOwnUsers(1)"> '+record+' </a>';
	}
	return s;
}
function viewOwnUsers(atype){
	var row = grid.getSelected();
	if (row) {
		var width=900,height=500,title='用户信息';
		if(id==0){
			title='新增筹资机构'
		}
		mini.open({
			url: "/user/user/viewOwnUsers?id="+row.user_id+"&atpye="+atype,
			showMaxButton:true,
			title: title, width: width, height:height
			
		});	
	}
}

</script>