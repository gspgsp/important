{layout file="public:mini_layout"}
<div style="width:99%; margin:5px;">
<div class="mini-tabs" activeIndex="0" plain="false" onactivechanged="changeTab">
  <div title="会员信息">
    <div class="mini-tabs">
    <div title="基本信息">
      <input class="mini-hidden" id="user_id" name="user_id" value="{$user.user_id}"/>
      <table border="0" cellpadding="1" cellspacing="2">
        <tr>
          <td style="width:80px;">手机：</td>
          <td style="width:350px;">{$user.mobile} {$user.info.ip_address}</td>
          <td colspan="2" rowspan="4" align="center" >{if $user.info.himg}<img src="__UPLOAD__/{$user.info.himg}" width="80">{else}-{/if}</td>
        </tr>
        <tr>
          <td>用户类型：</td>
          <td>{$utype.$user.info.utype} {if $user.info.user_tag}【{$user_tag.$user.info.user_tag}】{/if}</td>
        </tr>
        <tr>
          <td>邮件：</td>
          <td>{$user.email}</td>
        </tr>
        <tr>
          <td>状态：</td>
          <td>{$status.$user.status}</td>
        </tr>
        <tr>
          <td >最后登录：</td>
          <td>{if $user.last_login gt 1000}{$user.last_login|date:Y-m-d H:i:s}{else}{/if}（{$user.visit_count}次）</td>
          <td width="80">注册时间：</td>
          <td>{$user.info.reg_time|date:Y-m-d H:i:s}@{$user.info.reg_ip}</td>
        </tr>
        <tr>
          <td >姓名：</td>
          <td>{$user.info.real_name}</td>
          <td>{$idcard_type.$user.info.id_type}：</td>
          <td>{$user.info.id_card}</td>
        </tr>
        <tr>
          <td >性别：</td>
          <td>{if $user.info.sex eq '1'}男{elseif $user.info.sex eq '2'}女{/if}</td>
          <td>生日：</td>
          <td>{if $user.info.birthday neq '0000-00-00'}{$user.info.birthday}{/if}
            <!--<input class="mini-datepicker" name="birthday" style="width:100px;" value="{if $user.info.birthday neq '0000-00-00'}{$user.info.birthday}{/if}"/>--></td>
        </tr>
        <tr>
            <td>最高学历：</td>
            <td>{$education.$user.infoExt.education}</td>
            <td>入学年份：</td>
            <td>{$entrance.$user.infoExt.entrance}</td>
          </tr>
      <tr>
            <td>毕业院校：</td>
            <td>{$user.infoExt.school}</td>
            <td>籍贯：</td>
            <td>{$user.infoExt.origin}</td>
          </tr>
      <tr>
            <td>户口所在地：</td>
            <td>{$user.infoExt.domicile_place}</td>
            <td>居住城市：</td>
            <td>{$user.infoExt.area}</td>
          </tr>
      <tr>
            <td>居住地址：</td>
            <td>{$user.infoExt.address}</td>
            <td>居住地邮编：</td>
            <td>{$user.infoExt.zip}</td>
          </tr>
         
          <tr>
            <td>居住时长：</td>
            <td>{$live_long.$user.infoExt.length_residence}</td>
            <td>是否担保人：</td>
            <td>{if $user.info.is_security eq '0'}否{elseif $user.info.is_security eq '1'}是{/if}</td>
          </tr>
          <tr>
          <td colspan="4"><table width="100%">
            <tr>
              <td>邮箱认证：</td>
              <td>{if $user.info.chk_email}是{else}-{/if}</td>
              <td>银行认证：</td>
              <td>{if $user.info.chk_bank}是{else}-{/if}</td>
              <td>风险评估：</td>
              <td>{$chk_risk.$user.info.chk_risk}</td>
              <td>安全问题：</td>
              <td>{if $user.info.chk_safe}是{else}-{/if}</td>
            </tr>
            <tr>
              <td>支付密码：</td>
              <td>{if $user.info.has_paywd}是{else}-{/if}</td>
              <td>是否担保人：</td>
              <td>{if $user.is_security.has_paywd}是{else}-{/if}</td>
              <td>推荐人数：</td>
              <td>{$user.info.ref_count}</td>
              <td>备注：</td>
              <td>{$user.info.remarks}</td>
            </tr>
            <tr>
              <td>用户来源：</td>
              <td>{$user_chanel.$user.chanel}</td>
              <td>注册来源：</td>
              <td>{$user.info.chanel_name} {if $user.info.ref}<i title="{$user.info.ref}">查看</i>{else}-{/if}</td>
              <td>推荐人：</td>
              <td>{if $user.info.ref_uid}{$user.info.ref_uid}{/if}</td>
              <td></td>
              <td></td>
            </tr>
          </table></td>
          </tr>
      </table>
      </div>
      
      <div title="详细资料">
        <div style="height:385px">
          <table width="100%">
            <caption><strong>工作信息</strong></caption>
            <tr>
              <td>职业状况：</td>
              <td>{$occupation.$user.infoExt.occupation}</td>
              <td>单位名称：</td>
              <td>{$user.infoExt.work_name}</td>
            </tr>
            <tr>
              <td>职位：</td>
              <td>{$user.infoExt.position}</td>
              <td>月平均收入：</td>
              <td>{$mloan_amount.$user.infoExt.mloan_amount}</td>
            </tr>
            <tr>
              <td>工作邮箱：</td>
              <td>{$user.infoExt.work_email}</td>
              <td>工作城市：</td>
              <td>{$user.infoExt.work_city}</td>
            </tr>
            <tr>
              <td>公司地址：</td>
              <td>{$user.infoExt.work_address}</td>
              <td>公司类别：</td>
              <td>{$company_category.$user.infoExt.work_category}</td>
            </tr>
            <tr>
              <td>公司行业：</td>
              <td>{$company_industry.$user.infoExt.work_industry}</td>
              <td>公司规模：</td>
              <td>{$company_scale.$user.infoExt.work_scale}</td>
            </tr>
            <tr>
              <td>在现单位工作年限：</td>
              <td>{$work_years.$user.infoExt.work_years}</td>
              <td>公司电话：</td>
              <td>{$user.infoExt.work_phone}</td>
            </tr>
          </table>
          <br />
          <table width="100%">
            <caption><strong>家庭信息</strong></caption>
            <tr>
              <td>婚姻状况：</td>
              <td>{$marital.$user.infoExt.marital}</td>
              <td>有无子女：</td>
              <td>{$children.$user.infoExt.marital}</td>
            </tr>
            <tr>
              <td colspan="4"><strong>直属亲戚</strong></td>
            </tr>
            <tr>
              <td>姓名：</td>
              <td>{$user.infoExt.immediate_name}</td>
              <td>关系：</td>
              <td>{$user.infoExt.immediate_relation}</td>
            </tr>
            <tr>
              <td>手机：</td>
              <td>{$user.infoExt.immediate_mobile}</td>
              <td>&nbsp;</td>
              <td>&nbsp;</td>
            </tr>
            <tr>
              <td colspan="4"><strong>其他联系人</strong></td>
            </tr>
            <tr>
              <td>姓名：</td>
              <td>{$user.infoExt.other_name}</td>
              <td>关系：</td>
              <td>{$user.infoExt.other_relation}</td>
            </tr>
            <tr>
              <td>手机：</td>
              <td>{$user.infoExt.other_mobile}</td>
              <td>&nbsp;</td>
              <td>&nbsp;</td>
            </tr>
          </table>
          <br />
         <table width="100%">
          <caption><strong>贷款情况</strong></caption>
          <tr>
            <td>房贷情况：</td>
            <td>{$mortgage_situation.$user.infoExt.house_loan}</td>
            <td>平均每月还款额：</td>
            <td>{$user.infoExt.repay_loanamount}</td>
          </tr>
          <tr>
            <td>车贷情况：</td>
            <td>{$truck_situation.$user.infoExt.car_loan}</td>
            <td>每月车贷还款金额：</td>
            <td>{$user.infoExt.car_loanamount}</td>
          </tr>
        </table>
        </div>
      </div>
      <div title="认证信息">
       <div style="height:385px">
          <table style="width:100%;">
          {foreach from=$userAtt item=val}
          <tr>
            <td align="left" class="dt">{$user_verify.$val.atype}：</td>
            <td>{$val.name} <a href="__UPLOAD__/{$val.file_url}" target="_blank" onmouseover="showPic('__UPLOAD__/{$val.file_url}',this);" onmouseout="hidePic();">查看</a></td>
            <td><input id="atype_[{$val.atype}]" name="app[status][{$val.atype}]" class="mini-combobox" valueField="id" textField="name" value="{$val.status}" data='[{"id":"0","name":"待审核"},{"id":"1","name":"通过"},{"id":"2","name":"驳回"}]' required="true" onvaluechanged="verifyUserAtt({$val.atype},this.value);" /></td>
          </tr>
          {/foreach}
          </table>
        </div>
      </div>
      {if $user.info.utype eq 3}
      <div title="企业资料">
          <table width="100%" id="form_view">
            <tr>
              <td>公司名称：</td>
              <td><input name="company_name" class="mini-textbox" style="width:250px;" required="true" value="{$user.infoExt.company_name}"/></td>
              <td>&nbsp;</td>
              <td>&nbsp;</td>
            </tr>
            <tr>
              <td>公司类别：</td>
              <td><input class="mini-combobox" style="width:250px;" name="company_category" data='{:setMiniConfig|$company_category}' required="true" textfield="name" valuefield="id" value="{$user.infoExt.company_category}"/>
              </td>
              <td>公司行业：</td>
              <td><input class="mini-combobox" name="company_industry" data='{:setMiniConfig|$company_industry}' required="true" textfield="name" valuefield="id" value="{$user.infoExt.company_industry}"/>
              </td>
            </tr>
            <tr>
              <td>公司规模：</td>
              <td><input class="mini-combobox" name="company_scale" data='{:setMiniConfig|$company_scale}' required="true" textfield="name" valuefield="id" value="{$user.infoExt.company_scale}"/>
              </td>
              <td>月销售收入：</td>
              <td>
                <input name="company_revenue" class="mini-textbox" style="width:100px;" required="true" onvalidation="onValidFullMoney" value="{$user.infoExt.company_revenue|default:}"/>
              万
              </td>
            </tr>
            <tr>
              <td>经营场所：</td>
              <td><input class="mini-combobox" name="company_palce" data='{:setMiniConfig|$company_palce}' required="true" textfield="name" valuefield="id" value="{$user.infoExt.company_palce}"/>
              </td>
              <td>经营年限：</td>
              <td>
                <input name="company_period" class="mini-textbox" style="width:100px;" required="true" onvalidation="onValidFullMoney" value="{$user.infoExt.company_period|default:}"/>
              年
              </td>
            </tr>
            <tr>
              <td>所在省市</td>
              <td><input name="company_province" id="c_1_0" style="width:80px;" required="true" class="mini-combobox" textField="name" valueField="id" onvaluechanged="setReg('c')" data='{:setMiniConfig|$regionList}' value="{$user.infoExt.company_province}" showNullItem="true"/>
                <input name="company_city" id="c_2_0" required="true" class="mini-combobox" url="{if $user.infoExt.company_province}/user/user/getRegion?pid={$user.infoExt.company_province}{/if}" value="{$user.infoExt.company_city}" style="width:80px;" textField="name" valueField="id" />
              </td>
            </tr>          
            <tr>
              <td>公司地址：</td>
              <td><input name="company_address" class="mini-textbox" style="width:250px;" required="true" value="{$user.infoExt.company_address}"/></td>
              <td></td>
              <td></td>
            </tr>
          </table>
      </div>
      {elseif $user.info.utype eq 2}
      <div title="经纪人资料">
          <table width="100%" id="form_view">
          <tr>
            <td>机构名称：</td>
            <td><input name="agent_name" class="mini-textbox" value="{$user.infoExt.agent.name}" style="width:150px;" required="true"/></td>
            <td>机构类型：</td>
            <td><input name="agent_ecotype" class="mini-combobox" data='{:setMiniConfig|$eco_type}' style="width:150px;" required="true" textfield="name" valuefield="id" value="{$user.infoExt.agent.ecotype}"/></td>
          </tr>
          <tr>
            <td>联系人：</td>
            <td><input name="agent_contacts" class="mini-textbox" value="{$user.infoExt.agent.contacts}" style="width:150px;" required="true"/></td>
            <td>联系人电话：</td>
            <td><input name="agent_phone" class="mini-textbox" value="{$user.infoExt.agent.phone}" style="width:150px;" required="true" vtype="tel"/></td>
          </tr>
          <tr>
            <td>地址：</td>
            <td><input name="agent_address" class="mini-textbox" value="{$user.infoExt.agent.address}" style="width:150px;" required="true"/></td>
            <td>邮编：</td>
            <td><input name="agent_zip" class="mini-textbox" value="{$user.infoExt.agent.zip}" style="width:150px;" maxlength="6" required="true" vtype="zip"/></td>
          </tr>
          <tr>
            <td>客服经理代码：</td>
            <td><input class="mini-textbox" name="agent_customer_code" value="{$user.infoExt.agent.customer_code}" style="width:150px;"/></td>
          </tr>
        </table>
      </div>
      {/if}
    </div>
  </div>
  <div title="会员账户">
    <table border="0" cellpadding="1" cellspacing="2">
      <tr>
        <td colspan="4"><h3 style="padding:0; margin:0;">财务账户</h3></td>
      </tr>
      <tr>
        <td style="width:80px;">总资产：</td>
        <td style="width:210px;">{$user.account.capital}</td>
        <td style="width:80px;">信用等级：</td>
        <td style="width:210px;">{$credit_level.$user.account.credit_level}</td>
      </tr>
      <tr>
        <td style="width:80px;">总积分：</td>
        <td style="width:210px;">{$user.account.points}</td>
        <td style="width:80px;">累计逾期：</td>
        <td style="width:210px;">{$user.account.over_times}</td>
      </tr>
    </table>
    <div id="accountGrid" class="mini-datagrid" style="width:auto;height:340px;" idField="ac_type"  url="/user/account/init?action=grid&user_id={$user.user_id}" sizeList="[10,20,50,100]" pageSize="20">
      <div property="columns">
        <div field="ac_type" width="50" align="center" headerAlign="center" renderer="onLoadAccountLog">账户类型</div>
        <div header="账户状况" headerAlign="center">
          <div property="columns">
            <div field="surplus" width="50" headerAlign="center" align="right">余额</div>
            <div field="profit" width="50" headerAlign="center" align="right">冻结/盈亏</div>
            <div field="all_in" width="50" headerAlign="center" align="right">总收入</div>
            <div field="all_out" width="50" headerAlign="center" align="right">总支出</div>
          </div>
        </div>
        <div field="last_time" width="80" headerAlign="center" dateFormat="yy-MM-dd HH:mm" align="center">最后时间</div>
      </div>
    </div>
  </div>
  <div title="投资项目">
    <div id="investGrid" class="mini-datagrid" style="width:auto;height:420px;" idField="id"  url="/item/udeal/init?action=grid&user_id={$user.user_id}" sizeList="[10,20,50,100]" pageSize="20">
      <div property="columns">
        <div type="indexcolumn" headerAlign="center">序号</div>
        <div field="item_id" width="50" headerAlign="center" align="center">项目ID</div>
        <div field="principal" width="50" align="right" headerAlign="center">申购本金</div>
        <div field="interest" width="50" align="right" headerAlign="center">预期利率</div>
        <div field="act_principal" width="50" align="right" headerAlign="center">执行本金</div>
        <div field="act_interest" width="50" align="right" headerAlign="center">执行利率</div>
        <div field="ratio" width="50" align="right" headerAlign="center">占率%</div>
        <div field="bid_fee" width="50" align="right" headerAlign="center">竞价费</div>
        <div field="status" width="50" align="center" headerAlign="center" renderer="onLoadStatus">状态</div>
        <div field="value_date" width="80" headerAlign="center" dateFormat="yyyy-MM-dd" align="center">起息日</div>
        <div field="next_balance" width="80" headerAlign="center" dateFormat="yyyy-MM-dd" align="center">到期日</div>
      </div>
    </div>
  </div>
  <div title="银行列表">
    <div id="bankGrid" class="mini-datagrid" style="width:auto;height:420px;" idField="id"  url="/user/bank/init?action=grid&user_id={$user.user_id}" sizeList="[10,20,50,100]" pageSize="20">
      <div property="columns">
        <div field="bank_id" width="20" headerAlign="center" align="center">序号</div>
        <div field="user_name" width="50" headerAlign="center" allowSort="true" align="center">开户名</div>
        <div field="bank_name" width="55" headerAlign="center" allowSort="true" align="center">开户行</div>
        <div field="bank_region" width="60" headerAlign="center" allowSort="true" align="center">开户地址</div>
        <div field="account_no" width="100" headerAlign="center" allowSort="true" align="center">银行卡号</div>
        <div field="chk_status" width="60" headerAlign="center" allowSort="true" align="center">银行卡认证状态</div>
        <div field="last_time" width="85" headerAlign="center" dateFormat="yyyy-MM-dd HH:mm" allowSort="true" align="center">添加日期</div>
      </div>
    </div>
  </div>
  <div title="红包">
    <div id="coinsLists" class="mini-datagrid" style="width:auto;height:420px;" 
              url="/account/coins/report?keywordField=user_id&keyword={$user.user_id}&output=json" idField="id" pageSize="20"
     >
      <div property="columns">
        <div field="no" width="55" headerAlign="center" align="center">编号</div>
        <div field="passwd" width="60" headerAlign="center" align="center">激活码</div>
        <div field="amount" width="30" headerAlign="center" align="center">金额</div>
        <div field="status" width="20" headerAlign="center" align="center">状态</div>     
        <div field="actived_time" width="60" headerAlign="center" dateFormat="yyyy-MM-dd HH:mm" allowSort="true" align="center">激活时间</div>
        <div field="used_time" width="60" headerAlign="center" dateFormat="yyyy-MM-dd HH:mm" allowSort="true" align="center">使用时间</div>
      </div>
    </div>
  </div>  
  <div title="信用等级">
    <form id="creditForm" class="form">
      <input class="mini-hidden" type="hidden" name="info[user_id]" value="{$user.user_id}"/>
      <input class="mini-hidden" type="hidden" name="info[old_credit_level]" value="{$user.account.credit_level}"/>
      <table>
        <tr>
          <td class="dt">用户信用等级</td>
          <td><input name="info[credit_level]" class="mini-combobox" valueField="id" textField="name" value="{$user.account.credit_level}" data='{:setMiniConfig|$credit_level}' required="true" /></td>
        </tr>
        <tr>
          <td class="dt">修改审批备注</td>
          <td><textarea name="info[comments]" style="width:360px; height:80px;">{$user.apply_info.comments}</textarea></td>
        </tr>
      </table>
      <div style="text-align:center;padding:10px;"> {if !$info.status}<a class="mini-button" iconCls="icon-ok" onclick="creditSubmitForm">确定</a>{/if} <a class="mini-button" iconCls="icon-cancel" onclick="onCancel">取消</a> <span id="returnMsg" style="padding-left:5px; color:#F00;"></span> </div>
  </form>
  </div>
  
</div>
<div id="picShow" style="display:none;"></div>
<script type="text/javascript">
function showPic(url,obj){
  var width = $(window).innerWidth();
  var left = $(obj).offset().left;
  var top = $(obj).offset().top;
  if(width-left<380){
    left = left -370 +$(obj).width();
  }
  $('#picShow').show().css({"top":top+20+"px","left":left-10+"px","position":"absolute"}).html('<img width="380px" src="'+url+'" />');
}
function hidePic(){
  $('#picShow').hide();
}
mini.parse();

var accountGrid = mini.get("accountGrid"),investGrid=mini.get("investGrid"),bankGrid=mini.get("bankGrid"),creditGrid=mini.get("creditGrid"),coinsLists=mini.get("coinsLists");
accountGrid.sortBy("ac_type", "asc");
function changeTab(e){
  var tab=e.tab;
  if(tab.title=='会员账户'){
    var data=accountGrid.getData();
    if(data.length<1){
      accountGrid.load();
    }
  }else if(tab.title=='投资项目'){
    var data=investGrid.getData();
    if(data.length<1){
      investGrid.load();
    }
  }else if(tab.title=='银行列表'){
    var data=bankGrid.getData();
    if(data.length<1){
      bankGrid.load();
    }
  }else if(tab.title=='红包'){
    var data=coinsLists.getData();
    if(data.length<1){
      coinsLists.load();
    }
  }
}
function onLoadAccountLog(e){
  var record = e.record; //record.id
  return '<a href="javascript:viewAccountLog();" title="查看账户流水">'+record.ac_name+'</a>';
}
//查看编辑卡片信息
function viewAccountLog(){
  var row = accountGrid.getSelected(),user_id=row.user_id,ac_type=row.ac_type;
  url="/user/account/logs?user_id="+user_id+"&ac_type="+ac_type;
  mini.open({
    url: url,
    showMaxButton:true,
    title: "查看账户流水", width: 850, height:550
  });   
}

function creditSubmitForm(){
  var form = new mini.Form("#creditForm");
  form.validate();
  if(form.isValid() == false) return;
  form.loading("数据提交中，请稍后......");
  $.post('/user/user/creditSubmit',form.getData(),function(data){
    form.unmask();
    $("#returnMsg").text(data.msg);
    if(data.err=='0'){
      CloseWindow("save");
    }else{
      return false;
    }
  },'json');
}

function CloseWindow(action) {            
  if (window.CloseOwnerWindow) return window.CloseOwnerWindow(action);
  else window.close();            
}
function onCancel(e) {
  CloseWindow("cancel");
}

function verifyUserAtt(atype,status){
  $.post('/user/user/verifyUserAtt',{user_id:mini.get("user_id").getValue(),atype:atype,status:status},function(data){
    if(data.err=='0'){
    }else{
      alert(data.msg)
    }
  },'json');
}
{if $user.info.utype eq 3 || $user.info.utype eq 2}
//显示文本字段
var fields = (new mini.Form("form_view")).getFields();                
for (var i = 0, l = fields.length; i < l; i++) {
    var c = fields[i];
    if (c.setReadOnly) c.setReadOnly(true);     //只读
    if (c.setIsValid) c.setIsValid(true);      //去除错误提示
    if (c.addCls) c.addCls("asLabel");          //增加asLabel外观
}
{/if}
</script>
