{layout file="public:mini_layout"}
<style type="text/css">
.hidden {display:none;}
</style>
<div style="padding:5px;">
	<div id="infoForm" class="form">
		<div class="mini-tabs" activeIndex="0" plain="false">
			<div title="基本信息">
				<input class="mini-hidden" name="ctype" value="{$ctype}"/>
				<input class="mini-hidden" name="c_id" value="{$user.c_id}"/>
				<input class="mini-hidden" name="info_user_id" value="{$info_ext.user_id}"/>
				<table width="100%">
					<caption><strong>基本信息</strong></caption>
					<tr>
						<td>客户名称：</td>
						<td>
							<input name="c_name" class="mini-textbox" style="width:250px;" maxlength="50" required="true" value="{$user.c_name}"/>
						</td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td>法人姓名：</td>
						<td><input name="legal_person" class="mini-textbox" style="width:70px;" maxlength="6"  value="{$user.legal_person}"/></td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td>法人身份证：</td>
						<td><input name="legal_idcard" class="mini-textbox" style="width:250px;"  value="{$user.legal_idcard}"/></td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td>身份证照片：</td>
						<td colspan="3">
							<input id="img_url5"  name="legal_idcard_pic" class="mini-textbox" value="{$user.legal_idcard_pic}" style="width:200px"/>
							<input id="upfileId5" type="file" name="upFile" onChange="fileUpload(5);">
						</td>
					</tr>
					<tr>
						<td>所需牌号：</td>
						<td><input name="need_product" class="mini-textbox" style="width:250px;" value="{$user.need_product}"/></td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td>主营产品：</td>
						<td><input name="main_product" class="mini-textbox" style="width:250px;"  value="{$user.main_product}"/></td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td style="color:red">注意：</td>
						<td style="color:red">塑料制品企业(原工厂)需要填所需牌号、主营产品，原材料供应商(原贸易商、工贸一体)需要填所需牌号，</td>
					</tr>
					<tr>
						<td style="color:red"></td>
						<td style="color:red">物流服务商需要填主营产品；所需牌号尽量以填写真实牌号，尽量避免使用汉字，以英文逗号分隔。</td>
					</tr>
					<tr>
						<td>月用量：</td>
						<td><input name="month_consum" class="mini-textbox" style="width:250px;"  value="{$user.month_consum}"/></td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td>所在省市</td>
						<td><input name="company_province" id="place_1_0" style="width:80px;" class="mini-combobox" textField="name" valueField="id" onvaluechanged="setReg('place')" data='{:setMiniConfig|$regionList}' value="{$user.company_province}" showNullItem="true"/>
							<input name="company_city" id="place_2_0" url="{if $user.company_province neq ''}/user/user/getRegion?pid={$user.company_province}{/if}" value="{$user.company_city}" class="mini-combobox" style="width:80px;" textField="name" valueField="id" /></td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
			 <!--    <tr>
						<td>邮政编码：</td>
						<td>
							<input name="zip" class="mini-textbox" value="{$user.zip}" style="width:100px;" maxlength="6"  vtype="zip"/>
						</td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr> -->
					<tr>
						<td>成立日期：</td>
						<td><input  class="mini-datepicker"  name="fund_date" value="{$user.fund_date}"/>
						</td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td>注册资本：</td>
						<td>
							<input name="registered_capital" class="mini-textbox" style="width:100px;" required="true" onvalidation="onValidFullMoney" value="{$user.registered_capital|default:}"/>
						万元
						</td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td>实到资本：</td>
						<td>
							<input name="true_capital" class="mini-textbox" style="width:100px;" required="true" onvalidation="onValidFullMoney" value="{$user.true_capital|default:}"/>
							万元
						</td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					{if $see1}
					{/if}
					<tr>
						<td>预信用额度：</td>
						<td>
							<input name="pre_credit_limit" class="mini-textbox" style="width:100px;" required="true" onvalidation="onValidFullMoney" value="{$user.credit_limit|default:}"/>
							万元
						</td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td>信用额度：</td>
						<td>
							<input name="credit_limit" class="mini-textbox" style="width:100px;" required="true" onvalidation="onValidFullMoney" value="{$user.credit_limit|default:}"/>
							万元
						</td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td>公司地址：</td>
						<td><input name="address" class="mini-textbox" style="width:250px;" value="{$user.address}"/></td>
						<td></td>
						<td></td>
					</tr>
				</table>
				<table>
					<caption><strong>扩展信息</strong></caption>
					{if $see}
					<tr>
						<td>客户类型：<font style="color:red;">*</font></td>
						<td><input name="type" class="mini-combobox" style="width:150px;" required="true" value="{$user.type}" data='{:setMiniConfig|$type}'  textfield="name" valuefield="id"/></td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					{else}
						<td><input name="type" class="mini-hidden" style="width:150px;" value="{$user.type}" data='{:setMiniConfig|$type}'  textfield="name" valuefield="id"/>
					{/if}
					<tr>
						<td>客户渠道：<font style="color:red;">*</font></td>
						<td><input name="chanel" class="mini-combobox" style="width:150px;" value="{$user.chanel}" data='{:setMiniConfig|$chanel}' required="true" textfield="name" valuefield="id"/></td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td>是否三证合一：<font style="color:red;">*</font></td>
						<td><input id="cards" name="cards" onvaluechanged="changeEvent()" class="mini-combobox" style="width:150px;" value="1" data='{:setMiniConfig|array(0=>'否',1=>'是')}' required="true" textfield="name" valuefield="id"/></td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
					<tr class="three hidden">
						<td>营业执照号：</td>
						<td><input class="mini-textbox" style="width:250px;" name="business_licence" value="{$user.business_licence}"/>
						</td>
						<td>执照照片：</td>
						<td>
							<input id="img_url1"  name="business_licence_pic" class="mini-textbox" value="{$user.business_licence_pic}" style="width:70px"/>
							<input id="upfileId1" type="file" name="upFile" onChange="fileUpload(1);">
						</td>
					</tr>
					<tr class="three hidden">
						<td>组织代码：</td>
						<td><input class="mini-textbox" style="width:250px;" name="organization_code" value="{$user.organization_code}"/>
						</td>
						<td>组织图片：</td>
						<td>
							<input id="img_url2"  name="organization_pic" class="mini-textbox" value="{$user.organization_pic}" style="width:70px"/>
							<input id="upfileId2" type="file" name="upFile" onChange="fileUpload(2);">
						</td>
					</tr>
					<tr class="three hidden">
						<td>税务登记码：</td>
						<td><input class="mini-textbox" style="width:250px;" name="tax_registration" value="{$user.tax_registration}"/>
						</td>
						<td>税务图片：</td>
						<td>
							<input id="img_url3"  name="tax_registration_pic" class="mini-textbox" value="{$user.tax_registration_pic}" style="width:70px"/>
							<input id="upfileId3" type="file" name="upFile" onChange="fileUpload(3);">
						</td>
					</tr>

					<tr>
						<td>信用等级：</td>
						<td><input class="mini-combobox" name="credit_level" data='{:setMiniConfig|$credit_level}' textfield="name" valuefield="id" value="{$user.credit_level}"/>
						</td>
						<td>附件地址：</td>
						<td>
							<input id="img_url0"  name="file_url" class="mini-textbox" value="{$user.file_url}" style="width:70px"/>
							<input id="upfileId0" type="file" name="upFile" onChange="fileUpload(0);">
						</td>
					</tr>
					<tr>
						<td>是否授信：</td>
						<td><input class="mini-combobox" name="is_credit" style="width:100px;" data='{:setMiniConfig|$credit}' required="true" textfield="name" valuefield="id" value="{$user.is_credit|default:0}"/></td>
					</tr>
					<tr>
						<td>状态：</td>
						<td><input class="mini-combobox" name="status" style="width:100px;" data='{:setMiniConfig|$status}' textfield="name" valuefield="id" value="{$user.status|default:1}"/></td>
					</tr>
					<tr>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
						<td>&nbsp;</td>
					</tr>
				</table>
			</div>
			<div title="联系人基本信息">
				<div style="height:385px">
					<table border="0" cellpadding="1" cellspacing="2">
								<tr>
									<td >姓名：</td>
									<td><input name="info_name" class="mini-textbox" style="width:150px;" required="true" vtype="rangeLength:2,30" value="{$info_ext.name}" /></td>
									<td>性别：</td>
									<td><input class="mini-combobox" name="info_sex" style="width:100px;" data='{:setMiniConfig|$sex}' required="true" textField="name" valueField="id" value="{$info_ext.sex}"/></td>
								</tr>
								<tr>
									<td style="width:80px;">手机：</td>
									<td style="width:210px;"><input name="info_mobile" class="mini-textbox" maxlength="11" value="{$info_ext.mobile}" style="width:150px;" required="true" onvalidation="onValidMobile"/></td>
									<td>电话：</td>
									<td><input name="info_tel" class="mini-textbox" style="width:150px;"  value="{$info_ext.tel}" vtype="rangeLength:6,14"/></td>
								</tr>
								<tr>
									<td style="width:80px;">QQ号：</td>
									<td style="width:210px;"><input name="info_qq" class="mini-textbox" maxlength="12" value="{$info_ext.qq}" style="width:150px;"/></td>
									<td>传真：</td>
									<td><input name="info_fax" class="mini-textbox" style="width:150px;" value="{$info_ext.fax}"  vtype="rangeLength:6,14"/></td>
								</tr>
								<tr>
									<td>邮件：</td>
									<td><input name="info_email" class="mini-textbox" style="width:150px;"  value="{$info_ext.email}" vtype="email"/></td>
									<td></td>
									<td></td>
								</tr>
								<tr>
									<td>备注：</td>
									<td colspan="3">
										<input name="info_remark" class="mini-textarea" value="{$info_ext.remark}" style="width:403px; height:50px;"/>
									</td>
								</tr>
								<tr>
									<td>状态：</td>
									<td><input class="mini-combobox" name="info_status" style="width:100px;" data='{:setMiniConfig|$status}' required="true" textField="name" valueField="id" value="{$info_ext.status}"/></td>
								</tr>
								<tr style="height:20px;"></tr>
								<tr>
									<td id="e_m" style="color:red;"></td>
								</tr>
								<tr>
									<td id="e_a"></td>
									<td id="e_name"></td>
									<td id="e_e"></td>
									<td id="ec_name"></td>
								</tr>
								<tr>
									<td id="e_b"></td>
									<td id="e_tel"></td>
									<td id="e_c"></td>
									<td id="e_mobile"></td>
									<td id="e_d"></td>
									<td id="e_customer_manager_name"></td>
								</tr>
							</table>
				</div>
			</div>
		</div><input name="utype" class="mini-textbox" style="display:none" value="3" vtype="utype"/>
		<div align="center" style="margin-top:10px;">
			<a class="mini-button" iconcls="icon-ok" onclick="submitForm">确定</a>
			<a class="mini-button" iconcls="icon-cancel" onclick="onCancel">关闭</a><span id="returnMsg" style="padding-left:5px; color:#F00;"></span>
		</div>
	</div>
</div>
<script src="__JS__/jquery/jquery.upload.js" type="text/javascript"></script>
<script charset="utf-8" src="__JS__/kindeditor/kindeditor.js"></script>
<script charset="utf-8" src="__JS__/kindeditor/lang/zh_CN.js"></script>
<script type="text/javascript">
mini.parse();
var form = new mini.Form("#infoForm");
function changeEvent(){
	var val = mini.get('cards').getValue();
	if(val == 1){
		$("#one").removeClass('hidden');
		$(".three").addClass('hidden');
		mini.get('merge_three').setValue('1');
		mini.get('a').setValue('');
		mini.get('b').setValue('');
		mini.get('c').setValue('');
		mini.get('img_url1').setValue('');
		mini.get('img_url2').setValue('');
		mini.get('img_url3').setValue('');

	}else{
		$(".three").removeClass('hidden');
		$("#one").addClass('hidden');
		mini.get('merge_three').setValue('0');
		mini.get('d').setValue('');
		mini.get('img_url4').setValue('');
		mini.get('img_url4').setValue('');
	}

}

function submitForm(){
	form.validate();
	if(form.isValid() == false) return;

	//提交数据
	var o = form.getData();
	var json = mini.encode(o);
	$("#returnMsg").text('');
	form.loading("数据提交中，请稍后......");
	{if $user.user_id eq ''}
	var urlstr = '/user/customer/addSubmit';
	{else}
	var urlstr = '/user/customer/editSubmit';
	{/if}
	$.post(urlstr,{data:json},function(data){
		form.unmask();
		$("#returnMsg").text(data.msg);
		if(data.have=='1'){
			$("#e_m").text('已存在手机号的信息：');
			$("#e_a").text('联系人姓名：');
			$("#e_name").text(data.name);
			$("#e_e").text('所属公司：');
			$("#ec_name").text(data.c_name);
			$("#e_b").text('固定电话：');
			$("#e_tel").text(data.tel);
			$("#e_c").text('手机号：');
			$("#e_mobile").text(data.mobile);
			$("#e_d").text('所属交易员：');
			$("#e_customer_manager_name").text(data.customer_manager_name);
			}
		if(data.err=='0'){
			CloseWindow("save");
		}else{
			return false;
		}
	},'json');
}

function CloseWindow(action) {
	if (window.CloseOwnerWindow) return window.CloseOwnerWindow(action);
	else window.close();
}
function onCancel(e) {
	CloseWindow("cancel");
}

function onValidMobile(e){
	 if (e.isValid) {
		 if(!utils.isMobile(e.value)){
			 e.errorText = "错误的手机号";
				e.isValid = false;
		 }
	 }
}
function onValidZip(e){
	 if (e.isValid) {
		 if(!utils.isZip(e.value)){
			 e.errorText = "错误的邮编";
				e.isValid = false;
		 }
	 }
}
//验证身份证
function onIDCardsValidation(e) {
					 if (e.isValid) {
							 var pattern = /\d*/;
							 if (e.value.length < 15 || e.value.length > 18 || pattern.test(e.value) == false) {
									 e.errorText = "必须输入15~18位数字";
									 e.isValid = false;
							 }
					 }
			 }
function setReg(name,val){
	var deptCombo = mini.get(name+"_1_0");
	var positionCombo = mini.get(name+"_2_0");
	onDeptChanged(deptCombo,positionCombo,val);
}
function onDeptChanged(deptCombo,positionCombo,val) {
	var id = deptCombo.getValue();

	positionCombo.setValue("");
	var url = "/user/user/getRegion?pid=" + id
	positionCombo.setUrl(url);
}
function fileUpload(id) {
	$.ajaxFileUpload({
		url:'/system/sysUpload/images?model={$action}',
			secureuri:false,
			fileElementId:'upfileId'+id,
			dataType: 'json',
			success: function (data, status) {
				if(data.err=='0'){
					mini.get("img_url"+id).setValue(data.msg);
				}
			},
			error: function (data, status, e){
				$("#picResult").html(e);
			}
		}
	)
	return false;
}
</script>
