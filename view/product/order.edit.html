{layout file="public:mini_layout"}
<link rel="stylesheet" type="text/css" href="__CSS__/zt/common.css"/>
<div style="padding:5px; " >
	<div id="infoForm" class="form">
	<input class="mini-hidden" name="o_id" value="{$info.o_id}"/>
	<input class="mini-hidden" name="order_sn" value="{$order_sn}"/>
	<div  style="padding:5px; " >
		<fieldset style="width:800px;border:solid 1px #aaa;margin-top:8px;position:relative;">
			<legend>订单信息</legend>
			<div id="editForm1" style="padding:5px; ">
				<table id="table1" width="100%" >
					<tr>
						<td>订单名称：</td>
						<td><input name="order_name" class="mini-textbox" style="width:125px;" maxlength="8"  required="true" value="{$info.order_name}"/>
						</td>
						<td>订单编号 : </td>
						{if $type neq 'edit'}
						<td>{$order_sn}</td>
						{else}
						<td>{$info.order_sn}</td>
						{/if}
						
					</tr>
					{if $order_type neq '2' && $type neq 'edit'}
					<tr>
						<td>是否销库存：</td>
						<td>
							 <input name="" class="mini-radiobuttonlist" onvaluechanged="changordertype" data="[{id: 1, text: '是'}, {id: 2, text: '否'}]"/>
						</td>
						<td>销售类型：</td>
						<td><input name="sales_type" class="mini-combobox" style="width:125px;" value="{$info.sales_type}" data='{:setMiniConfig|$sales_type}'   required="true" textfield="name" valuefield="id"/></td>
					</tr>
					<tr>
					{else}
					<tr>
						<td>采购类型：</td>
						<td><input name="purchase_type" class="mini-combobox" style="width:125px;" value="{$info.purchase_type}" data='{:setMiniConfig|$purchase_type}'   required="true" textfield="name" valuefield="id"/></td>
					
					{/if}	
						<td>客户名称：</td>
						<td>
							<input name="c_id" class="mini-buttonedit" onbuttonclick="usrChoose" value="{$info.c_id}" allowInput="false"  text="{$c_name}"  style="width:125px;" id="usrId"/>
						</td>
						
					</tr>
					<tr>
						<td>签订日期：</td>
						<td><input  class="mini-datepicker"  name="sign_time"  required="true" value="{$info.sign_time}"/>
						</td>
						<td>签订地点 : </td>
						<td><input name="sign_place" class="mini-textbox" style="width:125px;" maxlength="8"  required="true" value="{$info.sign_place}"/>
						</td>
						
					</tr>
					<tr>
						<td>财务记录 ：</td>
						<td><input name="financial_records" class="mini-combobox" style="width:125px;" value="{$info.financial_records}" data='{:setMiniConfig|$financial_records}'  required="true" textfield="name" valuefield="id"/></td>
						<td>运输方式 : </td>
						<td><input name="transport_type" class="mini-combobox" style="width:125px;" value="{$info.transport_type}" data='{:setMiniConfig|$transport_type}'  required="true" textfield="name" valuefield="id"/></td>
						
					</tr>
					<tr>
						<td>运费 : </td>
						<td><input name="freight_price" class="mini-textbox" style="width:125px;" maxlength="8"  required="true" value="{$info.freight_price}"/>
						</td>
						<td>提货日期：</td>
						<td><input  class="mini-datepicker"  name="pickup_time"  required="true" value="{$info.pickup_time}"/>
						</td>
					</tr>	
					<tr>
						<td>送货日期：</td>
						<td><input  class="mini-datepicker"  name="delivery_time"  required="true" value="{$info.delivery_time}"/>
						</td>
						<td>提货地点：</td>
						<td><input name="pickup_location" class="mini-textbox" style="width:125px;"  required="true" value="{$info.pickup_location}"/></td>
						
					</tr>
					<tr>
						<td>送货地点：</td>
						<td><input name="delivery_location" class="mini-textbox" style="width:125px;"  required="true" value="{$info.delivery_location}"/></td>
						<td>付款方式 : </td>
						<td><input name="pay_method" class="mini-combobox" style="width:125px;" value="{$info.pay_method}" data='{:setMiniConfig|$pay_method}'  required="true" textfield="name" valuefield="id"/></td>
						
					</tr>
					<tr>
						<td>付款日期：</td>
						<td>
						<input  class="mini-datepicker"  name="payment_time"  required="true" value="{$info.payment_time}"/>
						</td>
						<td>业务模式 : </td>
						<td><input name="business_model" class="mini-combobox" style="width:125px;" value="{$info.business_model}" data='{:setMiniConfig|$business_model}'  required="true" textfield="name" valuefield="id"/></td>
					</tr>
					<input class="mini-hidden"  id="require_number" name="require_number" value="0"/>
					<input class="mini-hidden"  id="total_price" name="total_price" value="0"/>
					<input class="mini-hidden"  id="o_type" name="order_type" value="{$order_type}"/>
				</table>
					</div>
				</fieldset>
			{if $otype eq 'addopus'}
				<fieldset style="width:800px;border:solid 1px #aaa;margin-top:8px;position:relative;display:none;" id="consumeStore">
					<legend>销库存订单</legend>
					<div id="editForm2" style="padding:5px;" >
					<div class="detail">
						<table style=" width: 790px;">
						        <tr>
						            <th>牌号</th>
						            <th>仓库</th>
						            <th>批次</th>
						            <th>售价</th>
						            <th>数量</th>
						            <th>总价</th>
						            <th>操作</th>
						        </tr>
						    </table>
						    <!--total begin-->
						    <div class="total">
						        <span class="total-money">合计金额小写：<input type="text" value="0"/></span>
						        <span class="total-amount">合计数量：<input type="text" value="0"/></span>
						    </div>
						    <!--total end-->
					</div>
					</div>
				</fieldset>
				<fieldset style="width:800px;border:solid 1px #aaa;margin-top:8px;position:relative;display:none;" id="sale">
					<legend>销售订单</legend>
					<div id="editForm3" style="padding:5px;" >
					<div class="detail">
						<table style=" width: 790px;">
						        <tr>
						            <th>牌号</th>
						            <th>售价</th>
						            <th>数量</th>
							<th>总价</th>
						            <th>操作</th>
						        </tr>
						    </table>
						    <!--total begin-->
						    <div class="total">
						        <span class="total-money">合计金额小写：<input type="text" value="0"/></span>
						        <span class="total-amount">合计数量：<input type="text" value="0"/></span>
						    </div>
						    <!--total end-->
					</div>
					</div>
				</fieldset>
			{/if}
			{if $order_type eq 2}
			<fieldset style="width:800px;border:solid 1px #aaa;margin-top:8px;position:relative;" id="purchase">
					<legend>采购订单</legend>
					<div id="editForm3" style="padding:5px;" >
					<div class="detail">
						<table style=" width: 790px;">
						        <tr>
						            <th>牌号</th>
						            <th>客户</th>
						            <th>售价</th>
						            <th>数量</th>
							<th>总价</th>
						            <th>操作</th>
						        </tr>
						    </table>
						    <!--total begin-->
						    <div class="total">
						        <span class="total-money">合计金额小写：<input type="text" value="0"/></span>
						        <span class="total-amount">合计数量：<input type="text" value="0"/></span>
						    </div>
						    <!--total end-->
					</div>
					</div>
			</fieldset>
			{/if}
			</div>
		</div>	
		</div>
</div>
		<div align="center" style="margin-top:10px;">
		{if $otype eq 'addopus'}
			{if $order_type neq '2'}
			<a class="mini-button" iconCls="icon-add"  id="addSaleType" >销售明细</a>
			{else}
			<a class="mini-button" iconCls="icon-add"  onclick="addPurDetil" >采购明细</a>

			{/if}
		{/if}
			<a class="mini-button" iconcls="icon-ok" onclick="submitForm">确定</a>
			<a class="mini-button" iconcls="icon-cancel" onclick="onCancel">关闭</a><span id="returnMsg" style="padding-left:5px; color:#F00;"></span>
		</div>
<script src="__JS__/jquery/jquery.upload.js" type="text/javascript"></script>
<script charset="utf-8" src="__JS__/kindeditor/kindeditor.js"></script>
<script charset="utf-8" src="__JS__/kindeditor/lang/zh_CN.js"></script>
<script type="text/javascript">
mini.parse();
var form = new mini.Form("#infoForm");
var cid = mini.get("#usrId").getValue();
function submitForm(){
	// form.validate();
	// if(form.isValid() == false) return;
	//提交数据
	var o = form.getData();
	var json = mini.encode(o);
	$("#returnMsg").text('');
	form.loading("数据提交中，请稍后......");
	var urlstr = '/product/order/addSubmit';
	$.post(urlstr,{data:json},function(data){
		form.unmask();
		$("#returnMsg").text(data.msg);
		if(data.err=='0'){
			CloseWindow("save");
		}else{
			return false;
		}
	},'json');
}
function changordertype(e){
	var val = e.value;
	var addSaleType = mini.get("addSaleType");
	//1为销库存
	if(val == 1){
		addSaleType.on("click",consumeStoreDetil).un("click",saleDetil);
		$("#sale").hide();
		$("#consumeStore").show();
	}else{
		addSaleType.on("click",saleDetil).un("click",consumeStoreDetil); 
		$("#consumeStore").hide();
		$("#sale").show();
	}
}
function CloseWindow(action) {            
	if (window.CloseOwnerWindow) return window.CloseOwnerWindow(action);
	else window.close();            
}
function onCancel(e) {
	CloseWindow("cancel");
}
//强制选择归属公司
function usrChoose(e){
	var btn = this;
		mini.open({
		url: "/user/customer/init?do=search",
		title: "选择公司",
		width: 1200,
		height: 550,
		onload: function () {
			var data=e.sender.getValue();
			top['win'].setDvalue(data);  //去调用子页面的方法。
		},
		ondestroy: function (action) {
			if (action == "ok") {
				var iframe = this.getIFrameEl();
				var data = iframe.contentWindow.GetData();
				data = mini.clone(data);    //必须
				if (data) {
					btn.setValue(data.c_id);
					btn.setText(data.c_name);
				}
			}
		}
	});         
}
//强制选择归属订单
function ordChoose(e){
	var btn = this;
		mini.open({
		url: "/product/order/init?do=search",
		title: "选择订单",
		width: 1250,
		height: 550,
		onload: function () {
			var data=e.sender.getValue();
			top['win'].setDvalue(data);  //去调用子页面的方法。
		},
		ondestroy: function (action) {
			if (action == "ok") {
				var iframe = this.getIFrameEl();
				var data = iframe.contentWindow.GetData();
				data = mini.clone(data);    //必须
				if (data) {
					btn.setValue(data.o_id);
					btn.setText(data.order_name);
				}
			}
		}
	});         
}
//强制选择归属产品
function proChoose(e){
	var btn = this;
		mini.open({
		url: "/product/product/init?ischecked=checked",
		title: "选择产品",
		width: 1250,
		height: 550,
		onload: function () {
			var data=e.sender.getValue();
			top['win'].setDvalue(data);  //去调用子页面的方法。
		},
		ondestroy: function (action) {
			if (action == "ok") {
				var iframe = this.getIFrameEl();
				var data = iframe.contentWindow.GetData();
				data = mini.clone(data);    //必须
				if (data) {
					btn.setValue(data.id);
					btn.setText(data.model);
				}
			}
		}
	});         
}
//追加销售明细(销库存)
var k = 0;
var count = 0;
function consumeStoreDetil(){
	var require_num  = parseInt(mini.get("require_number").getValue());
	var btn = this;
	mini.open({
		url: "/product/saleLog/info?choose=1&require_num="+require_num,
		title: "新增销售明细",
		width: 750,
		height: 530,
		onload: function () {
			var data=e.sender.getValue();
			top['win'].setDvalue(data);  //去调用子页面的方法。
		},
		ondestroy: function (action) {
			if (action == "ok") {
				var iframe = this.getIFrameEl();
				var data = iframe.contentWindow.GetData();
				data = mini.clone(data);    //必须
				data = eval("(" + data + ")");
				if (data) {
					var time_price = parseInt(data.unit_price)*parseInt(data.require_number);
					var st = '<tr>'+
						'<td>'+data.model+'</td>'+
						'<td>'+data.store_name+'</td>'+
						'<td >'+data.lot_num+'</td>'+
						'<td>'+data.unit_price+'</td>'+
						'<td class="amount">'+data.require_number+'</td>'+
						'<td class="money">'+time_price+'</td>'+
						'<td class="opt"><span>删除</span></td>'+
						'<td style="border:none;">'+
						'<input class="mini-hidden" name="p_id'+k+'" value="'+data.p_id+'"/>'+
						'<input class="mini-hidden" name="store_id'+k+'" value="'+data.store_id+'"/>'+
						'<input class="mini-hidden" name="lot_num'+k+'" value="'+data.lot_num+'"/>'+
						'<input class="mini-hidden" name="unit_price'+k+'" value="'+data.unit_price+'"/>'+
						'<input  class="mini-hidden" name="require_number'+k+'" value="'+data.require_number+'"/>'+
						'<input class="mini-hidden" name="remark'+k+'" value="'+data.remark+'"/>'+
						'<input class="mini-hidden" name="inlog_id'+k+'" value="'+data.inlog_id+'"/>'+
						'</td>'+
					'</tr>';
					detailTable.append(st);
					mini.parse();
					//计算总金额与总数量
					var totalMoney = $(".total-money input");
						totalMoney.val(parseInt(totalMoney.val())+parseInt(time_price));
					var totalAmount = $(".total-amount input");
						totalAmount.val(parseInt(totalAmount.val())+parseInt(data.require_number));
					var total_price = mini.get('total_price').getValue();
					mini.get('total_price').setValue(totalMoney.val()); //每次取出总价加上单笔明细的价格
				}
			}
		}
	});
	k++;
}
//追加销售明细(不销库存)
var j = 0;
function saleDetil(){
	var btn = this;
	mini.open({
		url: "/product/saleLog/info?&choose=1&nostore=1",
		title: "新增采购明细",
		width: 250,
		height: 250,
		onload: function () {
			var data=e.sender.getValue();
			top['win'].setDvalue(data);  //去调用子页面的方法。
		},
		ondestroy: function (action) {
			if (action == "ok") {
				var iframe = this.getIFrameEl();
				var data = iframe.contentWindow.GetData();
				data = mini.clone(data);    //必须
				data = eval("(" + data + ")");
				if (data) {
					var time_price = parseInt(data.unit_price)*parseInt(data.require_number);
					var st = '<tr>'+
						'<td>'+data.model+'</td>'+
						'<td>'+data.unit_price+'</td>'+
						'<td class="amount">'+data.require_number+'</td>'+
						'<td class="money">'+time_price+'</td>'+
						'<td class="opt"><span>删除</span></td>'+
						'<td style="border:none;">'+
						'<input class="mini-hidden" name="p_id'+j +'" value="'+data.p_id+'"/>'+
						'<input class="mini-hidden" name="unit_price'+j +'" value="'+data.unit_price+'"/>'+
						'<input  class="mini-hidden" name="require_number'+j +'" value="'+data.require_number+'"/>'+
						'<input class="mini-hidden" name="remark'+j +'" value="'+data.remark+'"/>'+
						'</td>'+
					'</tr>';
					detailTable.append(st);
					mini.parse();
					//计算总金额与总数量
					var totalMoney = $(".total-money input");
						totalMoney.val(parseInt(totalMoney.val())+parseInt(time_price));
					var totalAmount = $(".total-amount input");
						totalAmount.val(parseInt(totalAmount.val())+parseInt(data.require_number));
					var total_price = mini.get('total_price').getValue();
					mini.get('total_price').setValue(totalMoney.val()); //每次取出总价加上单笔明细的价格
				}
			}
		}
	});
	j++;
}

//追加采购明细
var y = 0;
function addPurDetil(){
	var btn = this;
	mini.open({
		url: "/product/purchaseLog/info?&choose=1",
		title: "新增采购明细",
		width: 330,
		height: 320,
		onload: function () {
			var data=e.sender.getValue();
			top['win'].setDvalue(data);  //去调用子页面的方法。
		},
		ondestroy: function (action) {
			if (action == "ok") {
				var iframe = this.getIFrameEl();
				var data = iframe.contentWindow.GetData();
				data = mini.clone(data);    //必须
				data = eval("(" + data + ")");
				if (data) {
					var time_price = parseInt(data.unit_price)*parseInt(data.number);
					var st = '<tr>'+
						'<td>'+data.model+'</td>'+
						'<td>'+data.supplier+'</td>'+
						'<td>'+data.unit_price+'</td>'+
						'<td class="amount">'+data.number+'</td>'+
						'<td class="money">'+time_price+'</td>'+
						'<td class="opt"><span>删除</span></td>'+
						'<td style="border:none;">'+
						'<input class="mini-hidden" name="p_id'+y+'" value="'+data.p_id+'"/>'+
						'<input class="mini-hidden" name="c_id'+y+'" value="'+data.c_id+'"/>'+
						'<input class="mini-hidden" name="unit_price'+y+'" value="'+data.unit_price+'"/>'+
						'<input  class="mini-hidden" name="number'+y+'" value="'+data.number+'"/>'+
						'<input class="mini-hidden" name="remark'+y+'" value="'+data.remark+'"/>'+
						'</td>'+
					'</tr>';
					detailTable.append(st);
					mini.parse();
					//计算总金额与总数量
					var totalMoney = $(".total-money input");
						totalMoney.val(parseInt(totalMoney.val())+parseInt(time_price));
					var totalAmount = $(".total-amount input");
						totalAmount.val(parseInt(totalAmount.val())+parseInt(data.number));
					var total_price = mini.get('total_price').getValue();
					mini.get('total_price').setValue(totalMoney.val()); //每次取出总价加上单笔明细的价格

				}
			}
		}
	});
	y++;
}


	var detailTable = $(".detail table");		
	//删除某一条数据
	$(".detail table").find(".opt span").live("click",function(){ 
		var thisTr = $(this).closest("tr"),
		      index = thisTr.index();
		thisTr.remove();
		//计算总金额与总数量
		var totalMoney = $(".total-money input");
			totalMoney.val(parseInt(totalMoney.val())-parseInt(thisTr.find(".money").html()));
		var totalAmount = $(".total-amount input");
			totalAmount.val(parseInt(totalAmount.val())-parseInt(thisTr.find(".amount").html()));
		mini.get('total_price').setValue(totalMoney.val());
	});
	

</script>