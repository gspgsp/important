{layout file="public:mini_layout"}

<div style="padding:5px; " >
	<div id="infoForm" class="form">
	<input class="mini-hidden" name="o_id" value="{$info.o_id}"/>
	<input class="mini-hidden" name="order_sn" value="{$order_sn}"/>
	<div  style="padding:5px; " >

				<fieldset style="width:700px;border:solid 1px #aaa;margin-top:8px;position:relative;">
					<legend>订单信息</legend>
					<div id="editForm1" style="padding:5px; ">


				<table width="100%" >
					<tr>
						<td>订单名称：</td>
						<td><input name="order_name" class="mini-textbox" style="width:125px;" maxlength="8"  required="true" value="{$info.order_name}"/>
						</td>
						<td>订单编号 : </td>
						{if $type neq 'edit'}
						<td>{$order_sn}</td>
						{else}
						<td>{$info.order_sn}</td>
						{/if}
						
					</tr>
					<tr>
						<td>订单类型：</td>
						<td><input name="order_type" class="mini-combobox" style="width:125px;" value="{$info.order_type}" data='{:setMiniConfig|$order_type}'  onvaluechanged="changordertype" required="true" textfield="name" valuefield="id"/></td>
						<td>客户名称：</td>
						<td>
							<input name="c_id" class="mini-buttonedit" onbuttonclick="usrChoose" value="{$info.c_id}" allowInput="false"  text="{$c_name}"  style="width:125px;" id="usrId"/>
						</td>
						
					</tr>
					<tr>
						<td>签订日期：</td>
						<td><input  class="mini-datepicker"  name="sign_time"  required="true" value="{$info.sign_time}"/>
						</td>
						<td>签订地点 : </td>
						<td><input name="sign_place" class="mini-textbox" style="width:125px;" maxlength="8"  required="true" value="{$info.sign_place}"/>
						</td>
						
					</tr>
					<tr>
						<td>财务记录 ：</td>
						<td><input name="financial_records" class="mini-combobox" style="width:125px;" value="{$info.financial_records}" data='{:setMiniConfig|$financial_records}'  required="true" textfield="name" valuefield="id"/></td>
						<td>运输方式 : </td>
						<td><input name="transport_type" class="mini-combobox" style="width:125px;" value="{$info.transport_type}" data='{:setMiniConfig|$transport_type}'  required="true" textfield="name" valuefield="id"/></td>
						
					</tr>
					<tr>
						<td>运费 : </td>
						<td><input name="freight_price" class="mini-textbox" style="width:125px;" maxlength="8"  required="true" value="{$info.freight_price}"/>
						</td>
						<td>提货日期：</td>
						<td><input  class="mini-datepicker"  name="pickup_time"  required="true" value="{$info.pickup_time}"/>
						</td>
						
					<tr>
						<td>送货日期：</td>
						<td><input  class="mini-datepicker"  name="delivery_time"  required="true" value="{$info.delivery_time}"/>
						</td>
						<td>提货地点：</td>
						<td><input name="pickup_location" class="mini-textbox" style="width:125px;"  required="true" value="{$info.pickup_location}"/></td>
						
					</tr>
					<tr>
						<td>送货地点：</td>
						<td><input name="delivery_location" class="mini-textbox" style="width:125px;"  required="true" value="{$info.delivery_location}"/></td>
						<td>付款方式 : </td>
						<td><input name="pay_method" class="mini-combobox" style="width:125px;" value="{$info.pay_method}" data='{:setMiniConfig|$pay_method}'  required="true" textfield="name" valuefield="id"/></td>
						
					</tr>
					<tr>
						<td>付款日期：</td>
						<td>
						<input  class="mini-datepicker"  name="payment_time"  required="true" value="{$info.payment_time}"/>
						</td>
						<td>业务模式 : </td>
						<td><input name="business_model" class="mini-combobox" style="width:125px;" value="{$info.business_model}" data='{:setMiniConfig|$business_model}'  required="true" textfield="name" valuefield="id"/></td>
					</tr>
					<input class="mini-hidden"  id="require_number" name="require_number" value="0"/>
					<input class="mini-hidden"  id="total_price" name="total_price" value="0"/>
				</table>
					</div>
				</fieldset>
			{if $otype eq 'addopus'}
				<fieldset style="width:700px;border:solid 1px #aaa;margin-top:8px;position:relative;">
					<legend>新增明细</legend>
					<div id="editForm2" style="padding:5px; ">
					</div>
				</fieldset>
			{/if}	
			</div>
		</div>	
		</div>
</div>
		<div align="center" style="margin-top:10px;">
		{if $otype eq 'addopus'}
			<a class="mini-button" iconCls="icon-add"  id="addSaleType" >明细</a>
		{/if}
			<a class="mini-button" iconcls="icon-ok" onclick="submitForm">确定</a>
			<a class="mini-button" iconcls="icon-cancel" onclick="onCancel">关闭</a><span id="returnMsg" style="padding-left:5px; color:#F00;"></span>
		</div>
<script src="__JS__/jquery/jquery.upload.js" type="text/javascript"></script>
<script charset="utf-8" src="__JS__/kindeditor/kindeditor.js"></script>
<script charset="utf-8" src="__JS__/kindeditor/lang/zh_CN.js"></script>
<script type="text/javascript">
mini.parse();
var form = new mini.Form("#infoForm");
var cid = mini.get("#usrId").getValue();
function submitForm(){
	// form.validate();
	// if(form.isValid() == false) return;
	//提交数据
	var o = form.getData();
	var json = mini.encode(o);
	$("#returnMsg").text('');
	form.loading("数据提交中，请稍后......");
	var urlstr = '/product/order/addSubmit';
	$.post(urlstr,{data:json},function(data){
		form.unmask();
		$("#returnMsg").text(data.msg);
		if(data.err=='0'){
			CloseWindow("save");
		}else{
			return false;
		}
	},'json');
}
function changordertype(e){
	var val = e.value;
	var addSaleType = mini.get("addSaleType");
	val ==1 ? addSaleType.on("click",addSaleDetil).un("click",addPurDetil) :addSaleType.on("click",addPurDetil).un("click",addSaleDetil) ; 
		


}
function CloseWindow(action) {            
	if (window.CloseOwnerWindow) return window.CloseOwnerWindow(action);
	else window.close();            
}
function onCancel(e) {
	CloseWindow("cancel");
}
//强制选择归属公司
function usrChoose(e){
	var btn = this;
		mini.open({
		url: "/user/customer/init?do=search",
		title: "选择公司",
		width: 1200,
		height: 550,
		onload: function () {
			var data=e.sender.getValue();
			top['win'].setDvalue(data);  //去调用子页面的方法。
		},
		ondestroy: function (action) {
			if (action == "ok") {
				var iframe = this.getIFrameEl();
				var data = iframe.contentWindow.GetData();
				data = mini.clone(data);    //必须
				if (data) {
					btn.setValue(data.c_id);
					btn.setText(data.c_name);
				}
			}
		}
	});         
}
//强制选择归属订单
function ordChoose(e){
	var btn = this;
		mini.open({
		url: "/product/order/init?do=search",
		title: "选择订单",
		width: 1250,
		height: 550,
		onload: function () {
			var data=e.sender.getValue();
			top['win'].setDvalue(data);  //去调用子页面的方法。
		},
		ondestroy: function (action) {
			if (action == "ok") {
				var iframe = this.getIFrameEl();
				var data = iframe.contentWindow.GetData();
				data = mini.clone(data);    //必须
				if (data) {
					btn.setValue(data.o_id);
					btn.setText(data.order_name);
				}
			}
		}
	});         
}
//强制选择归属产品
function proChoose(e){
	var btn = this;
		mini.open({
		url: "/product/product/init?ischecked=checked",
		title: "选择产品",
		width: 1250,
		height: 550,
		onload: function () {
			var data=e.sender.getValue();
			top['win'].setDvalue(data);  //去调用子页面的方法。
		},
		ondestroy: function (action) {
			if (action == "ok") {
				var iframe = this.getIFrameEl();
				var data = iframe.contentWindow.GetData();
				data = mini.clone(data);    //必须
				if (data) {
					btn.setValue(data.id);
					btn.setText(data.model);
				}
			}
		}
	});         
}
//追加销售明细
var k = 0;
var count = 0;
function addSaleDetil(){
	var require_num  = parseInt(mini.get("require_number").getValue());
	var btn = this;
	mini.open({
		url: "/product/saleLog/info?choose=1&require_num="+require_num,
		title: "新增销售明细",
		width: 750,
		height: 530,
		onload: function () {
			var data=e.sender.getValue();
			top['win'].setDvalue(data);  //去调用子页面的方法。
		},
		ondestroy: function (action) {
			if (action == "ok") {
				var iframe = this.getIFrameEl();
				var data = iframe.contentWindow.GetData();
				data = mini.clone(data);    //必须
				data = eval("(" + data + ")");
				if (data) {
					var str1 = '<table><tr>';
					var str2 = '';
					var str3 = '';
					var oncecount= 0;
					for(var s in data){
						if( s =='model' || s =='store_name' || s =='lot_num' || s =='unit_price' || s=='require_number' || s=='remark' ){
							switch(s){
								case  'model':
									str1+='<td>牌号 :</td><td>'+data[s]+'</td><td>&nbsp;</td>';
									 break;
								case 'store_name':
									str1+='<td>仓库 :</td><td>'+data[s]+'</td><td>&nbsp;</td>';
									break;
								case  'lot_num':
									str1+='<td>批次 :</td><td>'+data[s]+'</td><td>&nbsp;</td>';
									break;
								case 'unit_price':
									str1+='<td>单价 :</td><td>'+data[s]+'</td><td>&nbsp;</td>';
									break;
								case 'require_number':
									str1+='<td>数量 :</td><td>'+data[s]+'</td><td>&nbsp;</td>';
									break;
								case  'remark':
									str1+='<td>备注 :</td><td>'+data[s]+'</td><td>&nbsp;</td>';
									break;
								default:
							}
						}		
						str2+='<input class="mini-hidden"  name="'+s+k+'" value="'+data[s]+'"/>';
						
					}
					oncecount =parseInt(data['require_number']) * parseInt(data['unit_price']);//单比总金额
					count +=parseInt(data['require_number']) * parseInt(data['unit_price']);//全部总金额
					mini.get("total_price").setValue(count); //累计计算总金额
					//叠加添加多次明细的数量 
					var require_number  = parseInt(mini.get("require_number").getValue());
					var count_num = require_number+parseInt(data.require_number);
					mini.get("require_number").setValue(count_num);
					str1+='<td>总价 :</td><td>'+oncecount+'</td></table>';
					$('#editForm2').append(str1);
					$('#editForm2').append(str2);
					$('#editForm2').append(str3);
					mini.parse();
				}
			}
		}
	});
	k++;
}
//追加采购明细
var j = 0;
function addPurDetil(){
	var btn = this;
	mini.open({
		url: "/product/purchaseLog/info?&choose=1",
		title: "新增采购明细",
		width: 450,
		height: 270,
		onload: function () {
			var data=e.sender.getValue();
			top['win'].setDvalue(data);  //去调用子页面的方法。
		},
		ondestroy: function (action) {
			if (action == "ok") {
				var iframe = this.getIFrameEl();
				var data = iframe.contentWindow.GetData();
				data = mini.clone(data);    //必须
				data = eval("(" + data + ")");
				if (data) {
					var str1 = '<table><tr>';
					var str2 = '';
					var str3 = '';
					for(var s in data){
						if( s =='number' || s =='unit_price' || s =='model' || s =='supplier' || s=='purchase_order_no' || s=='remark'){
							switch(s){
								case  'model':
									str1+='<td>牌号 :</td><td>'+data[s]+'</td><td>&nbsp;</td>';
									 break;
								case 'purchase_order_no':
									str1+='<td>采购单号 :</td><td>'+data[s]+'</td><td>&nbsp;</td>';
									break;
								case  'supplier':
									str1+='<td>供应商 :</td><td>'+data[s]+'</td><td>&nbsp;</td>';
									break;
								case 'unit_price':
									str1+='<td>单价 :</td><td>'+data[s]+'</td><td>&nbsp;</td>';
									break;
								case 'number':
									str1+='<td>数量 :</td><td>'+data[s]+'</td><td>&nbsp;</td>';
									break;
								case  'remark':
									str1+='<td>备注 :</td><td>'+data[s]+'</td><td>&nbsp;</td>';
									break;
								default:
							}
						}		
						str2+='<input class="mini-hidden"  name="'+s+j+'" value="'+data[s]+'"/>';
					}
					$('#editForm2').append(str1);
					$('#editForm2').append(str2);
					$('#editForm2').append(str3);
					mini.parse();
				}
			}
		}
	});
	j++;
}
</script>