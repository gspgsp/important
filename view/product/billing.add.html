{layout file="public:mini_layout"}
<div id="admInfo" title="" style="padding:10px;" showModal="true" allowResize="true" allowDrag="true">
  <div id="addForm" class="form" >
		<table style="width:100%;">
		<input class="mini-hidden" name="billing_type"  value="{$type}"/>
		<input class="mini-hidden" name="order_sn"  value="{$order_sn}"/>
		<input class="mini-hidden" name="o_id"  value="{$o_id}"/>
		<input class="mini-hidden" name="c_id"  value="{$c_id}"/>
		<input class="mini-hidden" name="unbilling_price"  value="{$unbilling_price}"/>
			<tr>
				{if $type =='1'}
				<td>销售订单发票号</td>
				{else}
				<td>采购订单发票号</td>
				{/if}
				<td><input name="invoice_sn" class="mini-textbox" maxlength="12" value="" style="width:150px;" required="true"/></td>
			</tr>
			<tr>
				<td>客户名称</td>
				<td><input name="" class="mini-textbox" maxlength="12" value="{$c_name}" style="width:150px;"allowInput="false"/></td>
			</tr>
			<tr>
				{if $type =='1'}
				<td>销售订单开票日期</td>
				{else}
				<td>采购订单开票日期</td>
				{/if}
				<td><input name="payment_time" class="mini-datepicker" style="width:150px;" format="yyyy-MM-dd" showTime="true" required="true"/></td>
			</tr>
			<tr>
				{if $type =='1'}
				<td>销售合同主题</td>
				{else}
				<td>采购合同主题</td>
				{/if}
				<td><input name="title" class="mini-textbox" maxlength="12" value="" style="width:150px;" required="true"/></td>
			</tr>
			<tr>
				<td>合同金额</td>
				<td><input name="total_price" class="mini-textbox" maxlength="12" value="{$price}" style="width:150px;" allowInput="false"/></td>
			</tr>
			<tr>
				<td>票据金额</td>
				<td><input name="billing_price" class="mini-textbox" maxlength="12" value="" style="width:150px;" required="true"/></td>
			</tr>
			<tr>
				<td>已开票金额</td>
				<td><input name="hasbilling_price" class="mini-textbox" maxlength="12" value="{$hasbilling_price}" style="width:150px;" allowInput="false"/></td>
			</tr>
			<tr>
				<td>税额</td>
				<td><input name="tax_price" class="mini-textbox" maxlength="12" value="" style="width:150px;" required="true"/></td>
			</tr>
			<tr>
				<td>抬头</td>
				<td><input name="rise" class="mini-textbox" maxlength="12" value="" style="width:150px;" required="true"/></td>
			</tr>
			
			<tr>
				<td>交易员</td>
				<td><input name="input_admin" class="mini-textbox" maxlength="12" value="{$input_admin}" style="width:150px;"allowInput="false"/></td>
			</tr>
			<tr>
				<td>票据类型</td>
				<td><input name="bile_type" class="mini-combobox" data='{:setMiniConfig|$bile_type}' textField="name" valueField="id" style="width:150px;" required="true"/></td>
			</tr>
			<tr>
				<td>附件</td>
				<td>
					<input id="file_url"  name="accessory" class="mini-textbox" value="" style="width:200px"/>
					<input id="upfileId" type="file" name="upFile" style="width:105px" onChange="fileUpload();">
				</td>
			</tr>
			<tr>
				<td>付款信息</td>
				<td><input name="paying_info" class="mini-textarea" style="width:300px; height:40px;"/></td>
			</tr>
			<tr>
				<td>收款信息</td>
				<td><input name="receipt_info" class="mini-textarea" style="width:300px; height:40px;"/></td>
			</tr>
			<tr>
				<td>备注</td>
				<td><input name="remark" class="mini-textarea" style="width:300px; height:50px;"/></td>
			</tr>
			<tr>
			<td style="text-align:center;padding-top:15px;padding-right:20px; margin-top:20px;" colspan="2">
				<a class="mini-button" iconCls="icon-ok" onclick="submitForm(billing=1)">提交</a>
				<a class="mini-button" iconCls="icon-cancel" onclick="onCancel">关闭</a>
				<span id="returnMsg" style="padding-left:5px; color:#F00;"></span>
			</td>
			</tr>
		</table>
	</div>
</div>
<fieldset style="width:480px;border:solid 1px #aaa;position:relative;">
        <legend>公司开票资料</legend>
        <div id="editForm1" style="padding:5px;">
            <input class="mini-hidden" name="id"/>
            <table style="width:100%;">
                <tr>
                    <td style="width:100px;">纳税人识别号</td>
                    <td style="width:150px;"><input name="Tax_Id" class="mini-textbox" value="{$Tax_Id}"allowInput="false"/></td>
                    <td style="width:80px;">开票地址</td>
                    <td style="width:150px;"><input name="Invoice_Address" class="mini-textbox" value="{$Invoice_Address}"allowInput="false"/></td>
                </tr>
                <tr>
                    <td>开票银行</td>
                    <td style="width:150px;"><input name="Invoice_Bank" class="mini-textbox" value="{$Invoice_Bank}"allowInput="false"/></td>
                    <td>开票帐号</td>
                    <td style="width:150px;"><input name="Invoice_Account" class="mini-textbox" value="{$Invoice_Account}"allowInput="false"/></td> 
                </tr>
                <tr>
                	<td style="width:80px;">开票电话</td>
                    <td style="width:150px;"><input name="Invoice_Tel" class="mini-textbox" value="{$Invoice_Tel}"allowInput="false"/></td> 
                </tr>
            </table>
        </div>
    </fieldset>


<fieldset style="width:480px;border:solid 1px #aaa;position:relative;">
<legend>订单详细信息</legend>
	<div id="investGrid" class="mini-datagrid" style="width:auto;height:200px;" idField="id" {if $type =='1'} url="/product/saleLog/init?action=grid&oid={$o_id}&type=1"{else}url="/product/purchaseLog/init?action=grid&oid={$o_id}&type=1"{/if} sizeList="[10,20,50,100]" pageSize="20">
		<div property="columns">
			<div field="id" width="30" headerAlign="center" align="center" allowSort="true" >ID</div>
			<div field="model" width="90" headerAlign="center" align="center">牌号</div>
			<div field="number" width="50" headerAlign="center" allowSort="true" align="center">数量</div>      
			<div field="unit_price" width="50" headerAlign="center" allowSort="true" align="center">单价</div>
			<div field="lot_num" width="50" headerAlign="center" allowSort="true" align="center">批次号</div>
			<div field="store_name" width="50" headerAlign="center" allowSort="true" align="center">仓库</div>
			<div field="sum" width="50" headerAlign="center" allowSort="true" align="center" id="sum">小计</div>
		</div>

	</div>
	<div>
		<span style="float:right">合计{$sum}</span>
	</div>
</fieldset>
<script src="__JS__/jquery/jquery.upload.js" type="text/javascript"></script>
<script type="text/javascript">
mini.parse();
//搜索或刷新
var admInfo = mini.get("admInfo");
var form = new mini.Form("#addForm");
var grid = mini.get("investGrid");

function search() {
	grid.load($("#soform").serializeObject(),function(e){
		$("#searchMsg").html(e.msg);
	});
}
search();
function onKeyEnter(e) {
	search();
}

//增加后提交数据(保存)
function submitForm(billing) {
	form.validate();
  	if (form.isValid() == false) return;
	//提交数据
	var o = form.getData();
	var json = mini.encode(o);
	form.loading("数据提交中，请稍后......");
	$.post('/product/order/ajaxSave',{data:json,do:billing},function(data){
		form.unmask();
		$("#returnMsg").text(data.msg);
		if(data.err=='0'){
			CloseWindow("save");
		}else{
			return false;
		}
	},'json');
}

function fileUpload() {
	$.ajaxFileUpload({
		url:'/system/sysUpload/upload',
			secureuri:false,
			fileElementId:'upfileId',
			dataType:'json',
			success: function (data) {
				if(data.error=='0'){
					mini.get("file_url").setValue(data.url);
				}
			},
			error: function (data, status, e){
				$("#picResult").html(e);
			}
		})
	return false;
}

function GetData() {
	var row = form.getSelected();
	return row;
}

function CloseWindow(action) {            
	if (window.CloseOwnerWindow) return window.CloseOwnerWindow(action);
	else window.close();            
}
function onCancel(e) {
	CloseWindow("cancel");
}

</script>